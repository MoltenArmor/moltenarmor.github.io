<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 7.2.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"blog.icku.eu.org","root":"/","images":"/images","scheme":"Pisces","darkmode":true,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="PXE什么是PXEPre-boot Execution Environment 预启动执行环境">
<meta property="og:type" content="article">
<meta property="og:title" content="网络引导详解">
<meta property="og:url" content="https://blog.icku.eu.org/2023/01/17/%E7%BD%91%E7%BB%9C%E5%BC%95%E5%AF%BC%E8%AF%A6%E8%A7%A3/index.html">
<meta property="og:site_name" content="MA Blog">
<meta property="og:description" content="PXE什么是PXEPre-boot Execution Environment 预启动执行环境">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2023-01-17T08:30:44.000Z">
<meta property="article:modified_time" content="2024-06-27T15:16:10.000Z">
<meta property="article:author" content="Molten_Armor">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://blog.icku.eu.org/2023/01/17/%E7%BD%91%E7%BB%9C%E5%BC%95%E5%AF%BC%E8%AF%A6%E8%A7%A3/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://blog.icku.eu.org/2023/01/17/%E7%BD%91%E7%BB%9C%E5%BC%95%E5%AF%BC%E8%AF%A6%E8%A7%A3/","path":"2023/01/17/网络引导详解/","title":"网络引导详解"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>网络引导详解 | MA Blog</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">MA Blog</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>







</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#PXE"><span class="nav-number">1.</span> <span class="nav-text">PXE</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFPXE"><span class="nav-number">1.1.</span> <span class="nav-text">什么是PXE</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8E%9F%E7%90%86"><span class="nav-number">1.2.</span> <span class="nav-text">原理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%94%A8%E9%80%94"><span class="nav-number">1.3.</span> <span class="nav-text">用途</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%90%AD%E5%BB%BA"><span class="nav-number">1.4.</span> <span class="nav-text">搭建</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Windows"><span class="nav-number">1.4.1.</span> <span class="nav-text">Windows</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#TinyPXE"><span class="nav-number">1.4.1.1.</span> <span class="nav-text">TinyPXE</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Linux-%E4%BC%A0%E7%BB%9FPXE-Cloud-init"><span class="nav-number">1.4.2.</span> <span class="nav-text">Linux 传统PXE+Cloud-init</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%89%E8%A3%85%E8%BD%AF%E4%BB%B6%E5%8C%85"><span class="nav-number">1.4.2.1.</span> <span class="nav-text">安装软件包</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9B%E5%BB%BATFTP%E6%96%87%E4%BB%B6%E5%A4%B9"><span class="nav-number">1.4.2.2.</span> <span class="nav-text">创建TFTP文件夹</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E5%BC%95%E5%AF%BC%E6%96%87%E4%BB%B6"><span class="nav-number">1.4.2.3.</span> <span class="nav-text">创建引导文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E5%86%85%E6%A0%B8%E6%96%87%E4%BB%B6"><span class="nav-number">1.4.2.4.</span> <span class="nav-text">创建内核文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%85%8D%E7%BD%AEDNSMASQ"><span class="nav-number">1.4.2.5.</span> <span class="nav-text">配置DNSMASQ</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9B%E5%BB%BAHTTP%E8%B5%84%E6%BA%90%E7%9B%AE%E5%BD%95"><span class="nav-number">1.4.2.6.</span> <span class="nav-text">创建HTTP资源目录</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9grub-cfg"><span class="nav-number">1.4.2.7.</span> <span class="nav-text">修改grub.cfg</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#autoinstall%E9%85%8D%E7%BD%AE"><span class="nav-number">1.4.2.8.</span> <span class="nav-text">autoinstall配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#autoinstall%E8%84%9A%E6%9C%AC"><span class="nav-number">1.4.2.9.</span> <span class="nav-text">autoinstall脚本</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Linux-iPXE-preseed"><span class="nav-number">1.4.3.</span> <span class="nav-text">Linux+iPXE+preseed</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%89%E8%A3%85%E8%BD%AF%E4%BB%B6%E5%8C%85-1"><span class="nav-number">1.4.3.1.</span> <span class="nav-text">安装软件包</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9B%E5%BB%BATFTP%E6%96%87%E4%BB%B6%E5%A4%B9-1"><span class="nav-number">1.4.3.2.</span> <span class="nav-text">创建TFTP文件夹</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%85%8D%E7%BD%AEDNSMASQ-1"><span class="nav-number">1.4.3.3.</span> <span class="nav-text">配置DNSMASQ</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9B%E5%BB%BAHTTP%E8%B5%84%E6%BA%90%E7%9B%AE%E5%BD%95-1"><span class="nav-number">1.4.3.4.</span> <span class="nav-text">创建HTTP资源目录</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9B%E5%BB%BAiPXE%E5%90%AF%E5%8A%A8%E8%84%9A%E6%9C%AC"><span class="nav-number">1.4.3.5.</span> <span class="nav-text">创建iPXE启动脚本</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#preseed%E8%87%AA%E5%8A%A8%E5%AE%89%E8%A3%85%E8%84%9A%E6%9C%AC"><span class="nav-number">1.4.3.6.</span> <span class="nav-text">preseed自动安装脚本</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#kickstart%E8%84%9A%E6%9C%AC"><span class="nav-number">1.4.3.7.</span> <span class="nav-text">kickstart脚本</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Docker-Cobbler"><span class="nav-number">1.4.4.</span> <span class="nav-text">Docker+Cobbler</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%89%E8%A3%85"><span class="nav-number">1.4.4.1.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E5%86%85%E5%AE%B9"><span class="nav-number">1.4.4.2.</span> <span class="nav-text">文件内容</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#cobbler%E5%91%BD%E4%BB%A4"><span class="nav-number">1.4.4.3.</span> <span class="nav-text">cobbler命令</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E6%B5%81%E7%A8%8B"><span class="nav-number">1.4.4.4.</span> <span class="nav-text">配置流程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AF%BC%E5%85%A5%E9%95%9C%E5%83%8F"><span class="nav-number">1.4.4.5.</span> <span class="nav-text">导入镜像</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AE%BE%E7%BD%AEKickstart"><span class="nav-number">1.4.4.6.</span> <span class="nav-text">设置Kickstart</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8PXE%E6%B5%8B%E8%AF%95"><span class="nav-number">1.4.4.7.</span> <span class="nav-text">启动PXE测试</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AE%BE%E7%BD%AEWeb"><span class="nav-number">1.4.4.8.</span> <span class="nav-text">设置Web</span></a></li></ol></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Molten_Armor</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">38</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/MoltenArmor" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;MoltenArmor" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:kwokjuy@163.com" title="E-Mail → mailto:kwokjuy@163.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.icku.eu.org/2023/01/17/%E7%BD%91%E7%BB%9C%E5%BC%95%E5%AF%BC%E8%AF%A6%E8%A7%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Molten_Armor">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MA Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="网络引导详解 | MA Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          网络引导详解
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-01-17 16:30:44" itemprop="dateCreated datePublished" datetime="2023-01-17T16:30:44+08:00">2023-01-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-06-27 23:16:10" itemprop="dateModified" datetime="2024-06-27T23:16:10+08:00">2024-06-27</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h1 id="PXE"><a href="#PXE" class="headerlink" title="PXE"></a>PXE</h1><h2 id="什么是PXE"><a href="#什么是PXE" class="headerlink" title="什么是PXE"></a>什么是PXE</h2><p>Pre-boot Execution Environment 预启动执行环境</p>
<span id="more"></span>
<p>是一种通过网络接口启动计算机的机制，这种机制让计算机的启动可以不依赖本地数据存储设备（如硬盘）或本地已安装的操作系统，由Intel发明。</p>
<h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p>客户机的固件（如网卡的PXE固件）先通过DHCP协议发送DHCP Discover消息，找到可用的PXE启动服务器的IP，找不到就一直等待到找到为止。<br>在找到可用的PXE启动服务器后，固件会向合适的启动服务器询问网络引导程序（NBP，Network Boot Program）的路径，并且通过TFTP协议将网络引导程序下载到电脑的内存中，最后执行它。<br>后续流程转交给网络引导程序，它通过 tftp 协议下载配置，了解它在哪里下载内核(kernel)、ramdisk和内核命令行以使用。<br>接下来的流程分为有盘和无盘系统启动，当客户端机器没有盘时，可以从网络磁盘启动（比如NFS）；客户端有盘时，ramdisk查看内核命令行以了解如何配置网络以及从何处下载操作系统镜像文件并执行自动化脚本安装操作系统，或者直接从已安装的磁盘启动（PXE会自动识别是直接安装还是直接启动）<br>因此PXE的实现依赖网卡的支持，只有支持 PXE 客户端的网卡才能实现网络自动安装(现在基本都支持，只需要在BIOS中打开网络引导功能)。这种网卡实现了 DHCP 客户端和 TFTP 客户端，在 BIOS 的引导下通过 DHCP 协议自动分配 IP 地址，通过 TFTP 获取最小内核，然后在最小内核环境下通过 HTTP 协议或 NFS 协议获取系统安装版本。<br>服务端的DHCP服务器必须支持PXE的相关选项(最好还支持网络唤醒)， 这些选项PXE客户端会通过DHCP Discover消息的Request Paramenter List来声明所有需要的选项，如果DHCP Server没有启用PXE启动支持，那么PXE客户端不会理会DHCP回应，继续发送请求。<br>一般网卡里的PXE固件，只支持通过DHCP和TFTP配合来启动；但是一些开源的项目，已经拓展了PXE的启动方式，支持通过HTTP, iSCSI, NFS来引导启动远程操作系统，比较有名的有iPXE(gPXE的继承者)，它们可以烧录在网卡上替代网卡出厂设置，也可以下载ipxe.efi文件写入EFI系统分区作为启动程序。<br><a target="_blank" rel="noopener" href="https://boot.ipxe.org/">iPXE下载</a><br>PXE bootloader(网络引导程序)也有一些知名的，比如syslinux, pxelinux, iPXE也可以作为bootloader来使用。</p>
<p>注：上图为EFI引导流程，若采用Legacy BIOS，那么 PXE 客户端请求的不是<code>bootx64.efi</code>而是<code>pxelinux.0</code><br>UEFI和传统模式之间的区别在于：在 UEFI 模式下，引导加载程序是 EFI 可执行文件，经过签名以便安全引导 SecureBoot 接受，而在传统模式下，它是 PXELINUX 。大多数 DHCP&#x2F;bootp 服务器可以配置为为特定机器提供正确的引导加载程序。<br>HTTP也可以改为使用NFS<br>一个内网存在两个DHCP服务器可能会存在冲突，在使用PXE时尽量不要同时存在两个DHCP服务器。<br><strong>不要使用无线网卡进行PXE</strong>。</p>
<h2 id="用途"><a href="#用途" class="headerlink" title="用途"></a>用途</h2><p>想象以下几个场景：</p>
<ol>
<li>有100台电脑需要进行统一化的系统安装</li>
<li>公司对信息安全要求比较高，需要使用无盘系统，工作站上不存在本地存储，全部使用中央服务器进行存储</li>
<li>你想要在别的电脑上启动你手上特定的系统</li>
</ol>
<h2 id="搭建"><a href="#搭建" class="headerlink" title="搭建"></a>搭建</h2><h3 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a>Windows</h3><p>Windows下的PXE服务端有TinyPXE，傲梅PXE和Serva。以TinyPXE为例。</p>
<h4 id="TinyPXE"><a href="#TinyPXE" class="headerlink" title="TinyPXE"></a>TinyPXE</h4><p>一些资源链接：<br><a target="_blank" rel="noopener" href="http://hidao.ysepan.com/">汉化版TinyPXE下载</a><br><a target="_blank" rel="noopener" href="http://erwan.labalec.fr/other/ipxe-snponly-x86-64.efi">iPXE UEFI内核, 放在files</a><br><a target="_blank" rel="noopener" href="http://git.ipxe.org/releases/wimboot/wimboot-latest.zip">iPXE wimboot内核, 放在files</a></p>
<ol>
<li>ProxyDHCP：是DHCP代理服务<br>勾选：在局域网已有DHCP服务的情况下，建议勾选，不会与现有DHCP服务冲突，但它能传递Next-Server等选项，传统DHCP服务不一定能传递参数和选项；<br>不勾选：如果局域网没有DHCP服务，可使用此软件的DHCP服务，就不勾选，客户端会得到该软件分配的IP。</li>
<li>HTTPd：开启本机的httpd服务，即web服务，可通过httpd服务来启动系统，浏览器可访问。</li>
<li>SMB：文件共享协议，勾选并启动后主机会把当前目录下的files目录共享出去，共享名为PXE，可通过命令：net share查看主机共享出去的目录。</li>
<li>Option：有多个Option项，在不启动ProxyDHCP时，它会让主机充当DHCP服务器，分配IP地址及这些选项都能生效，启动ProxyDHCP时，这里设定的IP地址&#x2F;子网&#x2F;DNS等选项被忽略，由主DHCP来分配，其它选项（比如Next-Server）可以被分配。</li>
<li>Boot File：启动文件，可选择files目录下的各种启动文件，默认ipxe.pxe适合BIOS&#x2F;UEFI等多种启动，在有些情况下也有选择pxelinux.0等的，一般保持默认。</li>
<li>Filename if user-class&#x3D;gPXE or iPXE：选择iPXE或gPXE启动菜单文件，默认menu.ipxe，在files目录下，可以根据这个模板生成自己的菜单文件。</li>
<li>More：更多选项（略）</li>
<li>TFTP服务：tftp服务是pxe启动的根本，运行TinyPXE时，tftp服务自动启动，没有tftp服务，就没有pxe在启动之初下载文件的能力，Httpd或Smb服务虽然能下载文件，但客户端pxe没有启动前是不能使用的；Tftp服务适合传输小文件，大文件传输太慢，旧的pxe仅基于tftp来传输，不适合安装大系统；检测服务启动是否成功，在命令行下运行<code>netstat -an | grep &quot;69&quot;</code></li>
<li>Tftpboot目录：即Tftp服务启动的根目录，它存放pxe启动文件和菜单文件，在软件里这个目录是files目录，我们可以在files下创建各系统的子目录，但目录结构要与menu.ipxe启动菜单内核和安装包文件对应一致。</li>
<li>日志：在软件面板中上部，有一块区域显示日志，客户端启动时获取IP，下载文件，执行启动等都会有日志显示在上面，这里可以在出错时给我们分析排除错误很大的帮助。<br><strong>iPXE启动菜单配置文件</strong><br>TinyPXE使用iPXE启动程序，系统提供了多个扩展名为.ipxe的菜单文件，但它并非只能叫这个扩展名，.txt或者别的扩展名也可以，只要它是纯文件文件，且符合ipxe的语法规则就可以。<br>以menu.ipxe为例<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">#!ipxe</span><br><span class="line"></span><br><span class="line">#set boot-url http://$&#123;proxydhcp&#125;/next-server</span><br><span class="line">set boot-url http://$&#123;next-server&#125;</span><br><span class="line">set iscsi-server $&#123;next-server&#125;</span><br><span class="line">set iqn iqn.2008-08.com.starwindsoftware:target1</span><br><span class="line">set iscsi-target iscsi:$&#123;iscsi-server&#125;::::$&#123;iqn&#125;</span><br><span class="line">set nfs-server $&#123;next-server&#125;</span><br><span class="line">set cifs-server //$&#123;next-server&#125;</span><br><span class="line"></span><br><span class="line"># Setup some basic convenience variables</span><br><span class="line">set menu-timeout 5000</span><br><span class="line">set submenu-timeout $&#123;menu-timeout&#125;</span><br><span class="line"></span><br><span class="line"># Ensure we have menu-default set to something</span><br><span class="line">isset $&#123;menu-default&#125; || set menu-default exit</span><br><span class="line"></span><br><span class="line">######## MAIN MENU ###################</span><br><span class="line">:start</span><br><span class="line">menu Welcome to iPXE&#x27;s Boot Menu</span><br><span class="line">item</span><br><span class="line">item --gap -- ------------------------- Utilities ------------------------------</span><br><span class="line">#item bootsan    Boot On San ($&#123;iscsi-target&#125;)</span><br><span class="line">item bootaoe    Boot On AOE (e0.0)</span><br><span class="line">#item iscsi	setup, sanhook or sanboot iscsi</span><br><span class="line">item iscsi	Boot On San</span><br><span class="line">item pxelinux    pxelinux</span><br><span class="line">item grub4dos    grub4dos</span><br><span class="line">item grub2    grub2</span><br><span class="line">#item grub_cd		boot to dvd (via grub4dos)</span><br><span class="line">#item grub_startrom		boot to startrom.0 (via grub4dos)</span><br><span class="line">item grub_floppy		boot floppy (via grub4dos)</span><br><span class="line">item grub_hd0		boot to hd0 (via grub4dos)</span><br><span class="line">item hdt    hdt</span><br><span class="line">#item netbootme	Netboot.Me</span><br><span class="line">#item undi_dos    undi_dos</span><br><span class="line">item disk_util Disk Utilities</span><br><span class="line">item winpe Live Systemes</span><br><span class="line">item linux Install Linux Distros</span><br><span class="line">item --gap -- ------------------------------ Advanced ---------------------------------</span><br><span class="line">item config       Configure settings</span><br><span class="line">item shell      Enter iPXE shell</span><br><span class="line">item reboot     Reboot</span><br><span class="line">item exit       Exit (boot local disk)</span><br><span class="line">choose --default exit --timeout 30000 target &amp;&amp; goto $&#123;target&#125;</span><br><span class="line"></span><br><span class="line">########## UTILITY ITEMS ####################</span><br><span class="line">:shell</span><br><span class="line">echo Type exit to get the back to the menu</span><br><span class="line">shell</span><br><span class="line">set menu-timeout 0</span><br><span class="line">goto start</span><br><span class="line"></span><br><span class="line">:failed</span><br><span class="line">echo Booting failed, dropping to shell</span><br><span class="line">goto shell</span><br><span class="line"></span><br><span class="line">:reboot</span><br><span class="line">reboot</span><br><span class="line"></span><br><span class="line">:exit</span><br><span class="line">exit</span><br><span class="line"></span><br><span class="line">:cancel</span><br><span class="line">echo You cancelled the menu, dropping you to a shell</span><br><span class="line"> </span><br><span class="line">:config</span><br><span class="line">config</span><br><span class="line">goto start</span><br><span class="line"> </span><br><span class="line">:back</span><br><span class="line">set submenu-timeout 0</span><br><span class="line">clear submenu-default</span><br><span class="line">goto start</span><br><span class="line">......后面省略</span><br></pre></td></tr></table></figure>
分为三个部分：预处理部分，主菜单部分，引导程序部分</li>
</ol>
<p>首行<br><code>#!ipxe</code>声明解释器</p>
<p>变量设置<br><code>set 变量名 值</code></p>
<p>变量调用<br>和shell一样，<code>$&#123;变量&#125;</code></p>
<p>代码段</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">:start</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>类似汇编的流程控制逻辑，到下一个冒号前，这段代码都是一个整体，会按照顺序执行，除非遇到goto跳转到其它的代码段。</p>
<p>设置菜单项<br><code>menu Welcome</code> 设置顶部显示的说明<br><code>item 代码段名 描述</code> 设置可选项目<br><code>item --gap 内容</code> 不可选择的分隔行<br><code>item --key 按键 代码段</code> 设置带快捷键的项目<br><code>choose [--dafault 代码段] [--timeout 时间毫秒] target &amp;&amp; goto $&#123;target&#125;</code></p>
<p>程序代码<br>例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">:win7    # Win7引导</span><br><span class="line">kernel $&#123;next-server&#125;/wimboot || goto failed</span><br><span class="line">initrd $&#123;next-server&#125;/windows7/boot/bcd bcd || goto failed</span><br><span class="line">initrd $&#123;next-server&#125;/windows7/boot/boot.sdi boot.sdi  || goto failed</span><br><span class="line">#windows的boot.wim最好是用微软工具生成的winpe启动文件，win10的也一样，在此不赘述</span><br><span class="line">initrd $&#123;next-server&#125;/windows7/sources/boot.wim boot.wim || goto failed</span><br><span class="line">boot || goto failed</span><br><span class="line">goto start</span><br><span class="line"></span><br><span class="line">:win10    # Win10引导</span><br><span class="line">kernel $&#123;next-server&#125;/wimboot || goto failed</span><br><span class="line">initrd $&#123;next-server&#125;/windows10/boot/bcd bcd || goto failed</span><br><span class="line">initrd $&#123;next-server&#125;/windows10/boot/boot.sdi boot.sdi  || goto failed</span><br><span class="line">initrd $&#123;next-server&#125;/windows10/sources/boot.wim boot.wim || goto failed</span><br><span class="line">boot || goto failed</span><br><span class="line">goto start</span><br><span class="line"></span><br><span class="line">:winpe    # WinPE引导</span><br><span class="line">sanboot --no-describe $&#123;boot-url&#125;/images/winpe.iso || goto failed</span><br><span class="line">goto start </span><br><span class="line"></span><br><span class="line">:clonezilla    # 再生龙引导</span><br><span class="line">initrd $&#123;boot-url&#125;/_ISO/clonezilla/live/initrd.img || goto failed</span><br><span class="line">kernel $&#123;boot-url&#125;/_ISO/clonezilla/live/vmlinuz boot=live config noswap nolocales edd=on nomodeset vga=788 nosplash noprompt fetch=$&#123;boot-url&#125;/_ISO/clonezilla/live/filesystem.squashfs || goto failed</span><br><span class="line">boot || goto failed</span><br><span class="line">goto start</span><br><span class="line"></span><br><span class="line">:debian    # debian引导</span><br><span class="line">cpuid --ext 29 &amp;&amp; set arch amd64 || set arch i386</span><br><span class="line"># sanboot http://ftp.fr.debian.org/debian/dists/Debian9.1/main/installer-amd64/current/images/netboot/mini.iso</span><br><span class="line">sanboot $&#123;boot-url&#125;/images/debian-10.7.0-amd64-netinst.iso || goto failed</span><br><span class="line">boot || goto failed</span><br><span class="line">goto start</span><br></pre></td></tr></table></figure>
<p>关键有以下几参数：<br><code>cpuid --ext 29 &amp;&amp; set arch x86_64 || set arch i386</code> 64位检测<br><code>|| goto failed</code> 失败跳转，可省略，但有它出错了它可以返回主菜单<br><code>kernel</code> 调用内核<br><code>initrd</code> 调用img<br><code>sanboot</code> 调用iso文件<br><code>kernel</code> 载入内核<br><code>initrd</code> 载入init ramdisk<br><code>chain</code>&#x3D;<code>boot</code> 引导，必须先载入必须的内核和ramdisk或ISO镜像<br>调用的文件，也是httpd服务或者smb服务上的文件，大文件不适合tftp服务来调用，速度非常慢，而httpd和smb传输文件非常快，所以代码段执行的文件调用建议都采用httpd路径来调取。<br>最终文件内容：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">#!ipxe</span><br><span class="line"></span><br><span class="line">set boot-url http://$&#123;next-server&#125;</span><br><span class="line"></span><br><span class="line"># Setup some basic convenience variables</span><br><span class="line">set menu-timeout 5000</span><br><span class="line"></span><br><span class="line"># Ensure we have menu-default set to something</span><br><span class="line">isset $&#123;menu-default&#125; || set menu-default exit</span><br><span class="line"></span><br><span class="line">######## MAIN MENU ###################</span><br><span class="line">:start</span><br><span class="line">menu Welcome to iPXE&#x27;s Boot Menu</span><br><span class="line">item</span><br><span class="line">item --gap -- ------------------------- Utilities ------------------------------</span><br><span class="line">item win7        Install Windows 7</span><br><span class="line">item win10       Install Windows 10</span><br><span class="line">item winpe       Winpe</span><br><span class="line">item clonezilla  Boot clonezilla</span><br><span class="line">item debian      Install Debian 10</span><br><span class="line">item --gap -- ------------------------------ Advanced ---------------------------</span><br><span class="line">item --key r reboot	[R] Reboot the Computer</span><br><span class="line">item --key x exit	[X] Exit (boot local disk)</span><br><span class="line">choose --default exit --timeout 60000 target &amp;&amp; goto $&#123;target&#125;</span><br><span class="line"></span><br><span class="line">########## UTILITY ITEMS ####################</span><br><span class="line">:failed</span><br><span class="line">echo Booting failed, dropping to shell</span><br><span class="line">goto start</span><br><span class="line"></span><br><span class="line">:reboot</span><br><span class="line">reboot</span><br><span class="line"></span><br><span class="line">:exit</span><br><span class="line">exit</span><br><span class="line"></span><br><span class="line">:win7</span><br><span class="line">kernel $&#123;next-server&#125;/wimboot || goto failed</span><br><span class="line">initrd $&#123;next-server&#125;/windows7/boot/bcd bcd || goto failed</span><br><span class="line">initrd $&#123;next-server&#125;/windows7/boot/boot.sdi boot.sdi  || goto failed</span><br><span class="line">#windows的boot.wim最好是用微软工具生成的winpe启动文件，win10的也一样，在此不赘述</span><br><span class="line">initrd $&#123;next-server&#125;/windows7/sources/boot.wim boot.wim || goto failed</span><br><span class="line">boot || goto failed</span><br><span class="line">goto start</span><br><span class="line"></span><br><span class="line">:win10</span><br><span class="line">kernel $&#123;next-server&#125;/wimboot || goto failed</span><br><span class="line">initrd $&#123;next-server&#125;/windows10/boot/bcd bcd || goto failed</span><br><span class="line">initrd $&#123;next-server&#125;/windows10/boot/boot.sdi boot.sdi  || goto failed</span><br><span class="line">initrd $&#123;next-server&#125;/windows10/sources/boot.wim boot.wim || goto failed</span><br><span class="line">boot || goto failed</span><br><span class="line">goto start</span><br><span class="line"></span><br><span class="line">:winpe</span><br><span class="line">sanboot --no-describe $&#123;boot-url&#125;/images/winpe.iso || goto failed</span><br><span class="line">goto start </span><br><span class="line"></span><br><span class="line">:clonezilla</span><br><span class="line">initrd $&#123;boot-url&#125;/_ISO/clonezilla/live/initrd.img || goto failed</span><br><span class="line">kernel $&#123;boot-url&#125;/_ISO/clonezilla/live/vmlinuz boot=live config noswap nolocales edd=on nomodeset vga=788 nosplash noprompt fetch=$&#123;boot-url&#125;/_ISO/clonezilla/live/filesystem.squashfs || goto failed</span><br><span class="line">boot || goto failed</span><br><span class="line">goto start</span><br><span class="line"></span><br><span class="line">:debian</span><br><span class="line">cpuid --ext 29 &amp;&amp; set arch amd64 || set arch i386</span><br><span class="line">#sanboot http://ftp.fr.debian.org/debian/dists/Debian9.1/main/installer-amd64/current/images/netboot/mini.iso</span><br><span class="line">sanboot $&#123;boot-url&#125;/images/debian-10.7.0-amd64-netinst.iso || goto failed</span><br><span class="line">boot || goto failed</span><br><span class="line">goto start</span><br></pre></td></tr></table></figure>

<p><strong>创建存储文件</strong><br>在files目录下创建指定文件夹和子文件夹<code>windows7\boot,windows7\sources,windows10\boot,windows10\sources,_ISO\clonezilla</code><br>将Windows镜像中的bcd，boot.sdi和boot.wim移入对应子目录中的boot文件夹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">copy x:\boot\bcd  pxesrv\files\windows7\boot\</span><br><span class="line">copy x:\boot\boot.sdi  pxesrv\files\windows7\boot\</span><br><span class="line">copy x:\sources\boot.wim  pxesrv\files\windows7\sources\</span><br><span class="line"></span><br><span class="line">copy x:\boot\bcd  pxesrv\files\windows10\boot\</span><br><span class="line">copy x:\boot\boot.sdi  pxesrv\files\windows10\boot\</span><br><span class="line">copy x:\sources\boot.wim  pxesrv\files\windows10\sources\</span><br></pre></td></tr></table></figure>
<p>将PE镜像文件和Linux镜像文件放入images文件夹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">copy winpe.iso pxesrv\files\images</span><br><span class="line">copy debian-10.7.0-amd64-netinst.iso pxesrv\files\images</span><br></pre></td></tr></table></figure>

<p><strong>启动服务端</strong></p>
<p><strong>设置BIOS，启用Netboot后启动客户端</strong></p>
<h3 id="Linux-传统PXE-Cloud-init"><a href="#Linux-传统PXE-Cloud-init" class="headerlink" title="Linux 传统PXE+Cloud-init"></a>Linux 传统PXE+Cloud-init</h3><h4 id="安装软件包"><a href="#安装软件包" class="headerlink" title="安装软件包"></a>安装软件包</h4><p>需要安装DHCP, TFTP和DNS服务器以实现PXE，<code>dnsmasq</code>包恰好同时实现了三种服务。<br>需要安装HTTP服务器以传输镜像和实现Cloud-init，<code>nginx</code>和<code>apache2</code>都可以，也可以使用<code>python3 -m http.server [port] [--bind IP] --directory|-d /var/www/html/</code>的简易服务器(此服务器默认使用当前目录，所以需要手动指定资源目录)。<br>需要安装两阶段的EFI Bootloader固件，第一阶段固件包名一般为<code>shim-signed</code>或<code>shim-x64</code>，第二阶段固件包名一般为<code>grub-efi-amd64-signed</code>或<code>grub2-efi-x64</code><br>需要一个用于网络安装的镜像。</p>
<h4 id="创建TFTP文件夹"><a href="#创建TFTP文件夹" class="headerlink" title="创建TFTP文件夹"></a>创建TFTP文件夹</h4><p>在符合规范的目录下创建tftp服务的根目录，目录下结构应当如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">tftp</span><br><span class="line">├── boot</span><br><span class="line">│   └── 镜像名</span><br><span class="line">│       ├── initrd</span><br><span class="line">│       └── vmlinuz</span><br><span class="line">├── grub</span><br><span class="line">│   ├── bootx64.efi</span><br><span class="line">│   ├── font.pf2</span><br><span class="line">│   └── grub.cfg</span><br><span class="line">└── grubx64.efi</span><br></pre></td></tr></table></figure>

<ol>
<li><code>bootx64.efi</code>来自<code>shim-signed</code>软件包</li>
<li><code>grubx64.efi</code> 引导程序来自<code>grub-efi-amd64-signed</code>软件包</li>
<li><code>grub.cfg</code> 自行拷贝或创建</li>
<li>其他文件如启动镜像<code>initrd</code>和内核<code>vmlinuz</code>来自镜像</li>
</ol>
<h4 id="创建引导文件"><a href="#创建引导文件" class="headerlink" title="创建引导文件"></a>创建引导文件</h4><p>创建目录后，执行<br><code>cp /usr/lib/shim/shimx64.efi.signed /.../tftp/grub/bootx64.efi</code> 创建bootx64.efi<br><code>cp /usr/lib/grub/x86_64-efi-signed/grubnetx64.efi.signed /.../tftp/grubx64.efi</code> 创建grubx64.efi</p>
<h4 id="创建内核文件"><a href="#创建内核文件" class="headerlink" title="创建内核文件"></a>创建内核文件</h4><p>先挂载镜像<code>mount -o ro xxx.iso /media</code><br>若提示<code>mount: /media: WARNING: device write-protected, mounted read-only.</code>，不影响使用。<br>执行<code>cp /media[/casper]/initrd /.../tftp/boot/镜像名/</code> 创建引导镜像<br>执行<code>cp /media[/casper]/vmlinuz /.../tftp/boot/镜像名/</code> 创建内核<br>执行<code>cp /media/grub/font.pf2 /.../tftp/grub/</code> 创建GRUB字体文件<br>执行<code>cp /media/grub/grub.cfg /.../tftp/grub/</code> 创建GRUB配置文件</p>
<h4 id="配置DNSMASQ"><a href="#配置DNSMASQ" class="headerlink" title="配置DNSMASQ"></a>配置DNSMASQ</h4><p>关键配置有以下几个：</p>
<ol>
<li>配置 DHCP 地址段</li>
<li>配置引导文件目录</li>
<li>配置 tftp 根目录</li>
<li>配置日志路径</li>
<li>配置监听网卡，多网卡机器尤其需要关注</li>
</ol>
<p>修改<code>/etc/dnsmasq.cconf</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"># 配置上游 DNS 服务器地址</span><br><span class="line">server=114.114.114.144</span><br><span class="line"></span><br><span class="line"># 指定服务的网卡</span><br><span class="line">interface=enp2s0,lo</span><br><span class="line"></span><br><span class="line"># 绑定端口</span><br><span class="line">bind-interfaces</span><br><span class="line"></span><br><span class="line"># 设置 DHCP 分发 IP 端范围、地址掩码、IP 地址有效时间</span><br><span class="line">dhcp-range=192.168.1.100,192.168.1.150,255.255.255.0,12h</span><br><span class="line"># 或者使用CIDR</span><br><span class="line">dhcp-range=192.168.1.100/24,192.168.1.150/24,12h</span><br><span class="line"></span><br><span class="line"># 根据架构设置引导程序，路径为相对于 tftp 根目录的路径</span><br><span class="line">dhcp-match=set:efi-x86_64,option:client-arch,7</span><br><span class="line">dhcp-match=set:efi-x86_64,option:client-arch,9</span><br><span class="line">dhcp-boot=tag:efi-x86_64,grub/bootx64.efi</span><br><span class="line"># 也可以使用pxe-service</span><br><span class="line">pxe-service=X86-64_EFI,&quot;PXELINUX (EFI)&quot;,grub/bootx64.efi</span><br><span class="line"></span><br><span class="line"># 启用 tftp 服务</span><br><span class="line">enable-tftp</span><br><span class="line"></span><br><span class="line"># 设置 tftp 根路径</span><br><span class="line">tftp-root=/srv/tftp</span><br><span class="line"></span><br><span class="line"># 设置日志路径</span><br><span class="line">log-facility=/var/log/dnsmasq.log</span><br></pre></td></tr></table></figure>
<p>修改配置后，重启 <code>dnsmasq</code> 服务才能生效。</p>
<h4 id="创建HTTP资源目录"><a href="#创建HTTP资源目录" class="headerlink" title="创建HTTP资源目录"></a>创建HTTP资源目录</h4><p>启动HTTP服务<code>systemctl start nginx|apache2</code><br>默认HTTP服务的资源根目录是 <code>/var/www/html</code>，目录下结构应当如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">html/</span><br><span class="line">├── autoinstall</span><br><span class="line">│   ├── meta-data</span><br><span class="line">│   └── user-data</span><br><span class="line">├── index.html(没用)</span><br><span class="line">└── iso</span><br><span class="line">    └── 镜像名.iso</span><br></pre></td></tr></table></figure>
<ol>
<li><code>autoinstall</code> 目录存放参数自动配置文件，<code>user-data</code>、<code>meta-data</code> 是cloud-init 要求的文件名</li>
<li><code>iso</code> 目录存放操作系统镜像文件</li>
</ol>
<h4 id="修改grub-cfg"><a href="#修改grub-cfg" class="headerlink" title="修改grub.cfg"></a>修改grub.cfg</h4><p>写入以下内容</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">set timeout=5</span><br><span class="line"></span><br><span class="line">if loadfont /grub/font.pf2 ; then</span><br><span class="line">    set gfxmode=auto</span><br><span class="line">    insmod efi_gop</span><br><span class="line">    insmod efi_uga</span><br><span class="line">    insmod gfxterm</span><br><span class="line">    terminal_output gfxterm</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">set menu_color_normal=white/black</span><br><span class="line">set menu_color_highlight=black/light-gray</span><br><span class="line"></span><br><span class="line">menuentry &quot;autoinstall&quot; &#123;</span><br><span class="line">    set gfxpayload=keep</span><br><span class="line">    linux  /boot/xxx/vmlinuz root=/dev/ram0 ramdisk_size=1500000 ip=dhcp url=&#x27;http://192.168.1.X/iso/xxx.iso&#x27; autoinstall ds=nocloud-net\;s=http://192.168.1.X/autoinstall/ ---</span><br><span class="line">    initrd /boot/xxx/initrd</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>指定镜像文件相对于 <code>tftp</code> 根目录的路径 <code>/boot/xxx/initrd</code></li>
<li><code>root=/dev/ram0 ramdisk_size=1500000</code> 是为了创建内核镜像的挂载空间，可删除</li>
<li><code>ip=dhcp</code> 指定内核镜像挂载后使用 DHCP 获取 IP 地址</li>
<li><code>url=</code> 指定 ISO 文件的网络存放路径</li>
<li><code>autoinstall ds=nocloud-net\;s=http://192.168.1.9/autoinstall/ ---</code> Grub中”;”有特殊含义，因此需要转义。注意末尾有空格和三个”-“，该配置指明配置文件所在路径，并指明参数自动填写</li>
</ol>
<h4 id="autoinstall配置"><a href="#autoinstall配置" class="headerlink" title="autoinstall配置"></a>autoinstall配置</h4><p><strong>配置 user-data</strong><br>遵循yaml格式，如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">#cloud-config</span><br><span class="line">autoinstall:</span><br><span class="line">  version: 1</span><br><span class="line">  # 修改apt服务地址</span><br><span class="line">  apt:</span><br><span class="line">    primary:</span><br><span class="line">    - arches: [default]</span><br><span class="line">      uri: https://mirrors.ustc.edu.cn/ubuntu</span><br><span class="line">  user-data:</span><br><span class="line">    # 配置时区</span><br><span class="line">    timezone: Asia/Shanghai</span><br><span class="line">    # 禁用root账号</span><br><span class="line">    disable_root: true</span><br><span class="line">  # 配置用户  </span><br><span class="line">  identity:</span><br><span class="line">    hostname: ubuntu-server</span><br><span class="line">    password: &quot;123456&quot;</span><br><span class="line">    username: ubuntu</span><br><span class="line">  # 配置键盘  </span><br><span class="line">  keyboard: &#123;layout: us, variant: &#x27;&#x27;&#125;</span><br><span class="line">  locale: en_US.UTF-8</span><br><span class="line">  # 默认安装ssh server</span><br><span class="line">  ssh:</span><br><span class="line">    install-server: true</span><br><span class="line">  # 指定安装的包</span><br><span class="line">  packages:</span><br><span class="line">    - net-tools</span><br><span class="line">    - python3-pip</span><br><span class="line">  # 配置磁盘分区</span><br><span class="line">  storage:</span><br><span class="line">    grub:</span><br><span class="line">      reorder_uefi: False</span><br><span class="line">    config:</span><br><span class="line">    - &#123;ptable: gpt, path: /dev/sda, wipe: superblock-recursive, preserve: false, name: &#x27;&#x27;, grub_device: false, type: disk, id: disk-sda&#125;</span><br><span class="line">    - &#123;device: disk-sda, size: 536870912, wipe: superblock, flag: boot, number: 1, preserve: false, grub_device: true, type: partition, id: partition-0&#125;</span><br><span class="line">    - &#123;fstype: fat32, volume: partition-0, preserve: false, type: format, id: format-0&#125;</span><br><span class="line">    - &#123;device: disk-sda, size: -1, wipe: superblock, flag: &#x27;&#x27;, number: 2, preserve: false, type: partition, id: partition-1&#125;</span><br><span class="line">    - &#123;fstype: xfs, volume: partition-1, preserve: false, type: format, id: format-1&#125;</span><br><span class="line">    - &#123;device: format-1, path: /, type: mount, id: mount-1&#125;</span><br><span class="line">    - &#123;device: format-0, path: /boot/efi, type: mount, id: mount-0&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>密码需要加密，可以先用工具对自己的密码进行加密后填入</li>
<li>磁盘分区配置要注意，配置不对会导致自动安装走不下去，提示 crash；这个配置的整体思路是先格式化 <code>disk-sda</code>，然后在 <code>disk-sda</code> 下划分 <code>/dev/sda1</code>、<code>/dev/sda2</code> ，然后分别挂载 <code>/</code>、<code>/boot/efi</code> 目录</li>
<li>安装过程日志在 <code>/var/log/installer/</code>，如果安装失败可以通过 <code>nc</code> 等工具实时发出去</li>
</ol>
<p><strong>配置meta-data</strong><br>touch创建一个空文件即可。<br><strong>vendor-data</strong><br>不需要理会。<br>确保以上文件所有人可读。<br>引导后即可自动安装。</p>
<h4 id="autoinstall脚本"><a href="#autoinstall脚本" class="headerlink" title="autoinstall脚本"></a>autoinstall脚本</h4><p>最小化的配置是：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">version: 1</span><br><span class="line">identity:</span><br><span class="line">    hostname: hostname</span><br><span class="line">    username: username</span><br><span class="line">    password: $crypted_pass</span><br></pre></td></tr></table></figure>
<p>一个标准设置为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">version: 1</span><br><span class="line">reporting:</span><br><span class="line">    hook:</span><br><span class="line">        type: webhook</span><br><span class="line">        endpoint: http://example.com/endpoint/path</span><br><span class="line">early-commands:</span><br><span class="line">    - ping -c1 198.162.1.1</span><br><span class="line">locale: en_US</span><br><span class="line">keyboard:</span><br><span class="line">    layout: gb</span><br><span class="line">    variant: dvorak</span><br><span class="line">network:</span><br><span class="line">    network:</span><br><span class="line">        version: 2</span><br><span class="line">        ethernets:</span><br><span class="line">            enp0s25:</span><br><span class="line">               dhcp4: yes</span><br><span class="line">            enp3s0: &#123;&#125;</span><br><span class="line">            enp4s0: &#123;&#125;</span><br><span class="line">        bonds:</span><br><span class="line">            bond0:</span><br><span class="line">                dhcp4: yes</span><br><span class="line">                interfaces:</span><br><span class="line">                    - enp3s0</span><br><span class="line">                    - enp4s0</span><br><span class="line">                parameters:</span><br><span class="line">                    mode: active-backup</span><br><span class="line">                    primary: enp3s0</span><br><span class="line">proxy: http://squid.internal:3128/</span><br><span class="line">apt:</span><br><span class="line">    primary:</span><br><span class="line">        - arches: [default]</span><br><span class="line">          uri: http://repo.internal/</span><br><span class="line">    sources:</span><br><span class="line">        my-ppa.list:</span><br><span class="line">            source: &quot;deb http://ppa.launchpad.net/curtin-dev/test-archive/ubuntu $RELEASE main&quot;</span><br><span class="line">            keyid: B59D 5F15 97A5 04B7 E230  6DCA 0620 BBCF 0368 3F77</span><br><span class="line">storage:</span><br><span class="line">    layout:</span><br><span class="line">        name: lvm</span><br><span class="line">identity:</span><br><span class="line">    hostname: hostname</span><br><span class="line">    username: username</span><br><span class="line">    password: $crypted_pass</span><br><span class="line">ssh:</span><br><span class="line">    install-server: yes</span><br><span class="line">    authorized-keys:</span><br><span class="line">      - $key</span><br><span class="line">    allow-pw: no</span><br><span class="line">snaps:</span><br><span class="line">    - name: go</span><br><span class="line">      channel: 1.14/stable</span><br><span class="line">      classic: true</span><br><span class="line">debconf-selections: |</span><br><span class="line">    bind9      bind9/run-resolvconf    boolean false</span><br><span class="line">packages:</span><br><span class="line">    - libreoffice</span><br><span class="line">    - dns-server^</span><br><span class="line">user-data:</span><br><span class="line">    disable_root: false</span><br><span class="line">late-commands:</span><br><span class="line">    - sed -ie &#x27;s/GRUB_TIMEOUT=.*/GRUB_TIMEOUT=30/&#x27; /target/etc/default/grub</span><br><span class="line">error-commands:</span><br><span class="line">    - tar c /var/log/installer | nc 192.168.0.1 1000</span><br></pre></td></tr></table></figure>
<p>关键字包括<br><strong>version</strong><br>名称：版本<br>类型：整型<br>默认值：无<br>为将来不同版本准备的版本信息，目前只能为 1 。<br><strong>locale</strong><br>名称：语言环境<br>类型：字符串<br>默认值：en_US.UTF-8<br>是否可交互：可，对于任何块中是的话，总是可以交互<br>为已安装系统配置的语言环境。<br><strong>network</strong><br>名称：网络<br>类型：netplan-format映射，参看下面<br>默认值：用于DHCP协议的名字为eth<em>en</em>的网卡<br>是否可交互：可<br>netplan 格式的网络配置。将在安装期间以及已安装的系统中应用。默认是解释安装媒介的配置，它在名称匹配 “eth” 或 “en” 的任何网卡上运行 DHCPv4 请求，并随后禁用任何未获取到IP地址的网卡。<br>例如，要在特定网卡 enp0s31f6 上运行 dhcp6 请求：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">network:</span><br><span class="line">  version: 2</span><br><span class="line">  ethernets:</span><br><span class="line">    enp0s31f6:</span><br><span class="line">      dhcp6: yes</span><br></pre></td></tr></table></figure>
<p><strong>apt</strong><br>名称：APT高级包管理工具<br>类型：映射<br>默认值：参看下面<br>是否可交互：可<br>APT配置，在安装期间和引导到目标系统后都使用。默认值为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">apt:</span><br><span class="line">    preserve_sources_list: false</span><br><span class="line">    primary:</span><br><span class="line">        - arches: [i386, amd64]</span><br><span class="line">          uri: &quot;http://archive.ubuntu.com/ubuntu&quot;</span><br><span class="line">        - arches: [default]</span><br><span class="line">          uri: &quot;http://ports.ubuntu.com/ubuntu-ports&quot;</span><br><span class="line">    geoip: true</span><br></pre></td></tr></table></figure>
<p>任何提供的配置都会与默认配置合并，而不是替换它。<br>如果您只想设置镜像源，请使用如下配置：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">apt:</span><br><span class="line">    primary:</span><br><span class="line">        - arches: [default]</span><br><span class="line">          uri: YOUR_MIRROR_GOES_HERE</span><br></pre></td></tr></table></figure>
<p><strong>storage</strong><br>名称：存储<br>类型：映射，参看下面<br>默认值：对于单块硬盘为 lvm ，对于多块硬盘则无默认值<br>是否可交互：可<br>支持的布局：目前支持的布局就两种，分别是逻辑卷模式 lvm 和直通模式 direct 。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">storage:</span><br><span class="line">  layout:</span><br><span class="line">    name: lvm</span><br><span class="line">storage:</span><br><span class="line">  layout:</span><br><span class="line">    name: direct</span><br></pre></td></tr></table></figure>
<p>默认情况下，这些将安装到系统中容量最大的磁盘，但可以提供匹配规范（“match: {}”，见下文）来指示要使用的磁盘：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">storage:</span><br><span class="line">  layout:</span><br><span class="line">    name: lvm</span><br><span class="line">    match:</span><br><span class="line">      serial: CT*</span><br><span class="line">storage:</span><br><span class="line">  layout:</span><br><span class="line">    name: disk</span><br><span class="line">    match:</span><br><span class="line">      ssd: yes</span><br></pre></td></tr></table></figure>
<p>默认采用 lvm 。<br><strong>基于动作的配置</strong><br>如果使用 layout 功能配置磁盘，则不会使用 config 部分。<br>除了将操作列表放在关键字 config 下之外， grub 和swap curtin配置项也可以放在此处。因此存储部分可能如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">storage:</span><br><span class="line">    swap:</span><br><span class="line">        size: 0</span><br><span class="line">    config:</span><br><span class="line">        - type: disk</span><br><span class="line">          id: disk0</span><br><span class="line">          serial: ADATA_SX8200PNP_XXXXXXXXXXX</span><br><span class="line">        - type: partition</span><br><span class="line">          ...</span><br></pre></td></tr></table></figure>
<p><strong>磁盘选择扩展</strong><br>Curtin支持通过串行或路径(如 &#x2F;dev&#x2F;sdc )识别磁盘，服务器安装程序也支持这一点。安装程序还支持磁盘操作上的 match spec，支持更灵活的匹配。<br>存储配置中的操作按照它们在自动安装文件中的顺序进行处理。任何磁盘操作都会被分配一个匹配的磁盘——如果有多个磁盘，则从一组未分配的磁盘中任意选择，如果没有未分配的匹配磁盘，则会导致安装失败。<br>匹配规范支持以下关键字：</p>
<ul>
<li>model: foo ：匹配 udev 中 ID_VENDOR&#x3D;foo 的磁盘，支持通配符</li>
<li>path: foo ：匹配 udev 中 DEVPATH&#x3D;foo 的磁盘，支持通配符（通配符支持将此与直接在磁盘操作中指定 path: foo 区分开来）</li>
<li>serial: foo ：匹配 udev 中 ID_SERIAL&#x3D;foo 的磁盘，支持通配符（通配符支持将此与直接在磁盘操作中指定 serial: foo 区分开来）</li>
<li>ssd: yes|no ：匹配是或不是 SSD 的磁盘（相对于机械硬盘）</li>
<li>size: largest|smallest ：如果有多个匹配项，则取最大或最小的磁盘而不是任意一个（在 20.06.1 版本中添加了对最小 smallest 的支持）<br>因此，例如，要匹配任意磁盘，只需：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- type: disk</span><br><span class="line">  id: disk0</span><br></pre></td></tr></table></figure>
匹配容量最大的SSD硬盘：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- type: disk</span><br><span class="line">  id: big-fast-disk</span><br><span class="line">  match:</span><br><span class="line">    ssd: yes</span><br><span class="line">    size: largest</span><br></pre></td></tr></table></figure>
匹配希捷Seagate硬盘：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- type: disk</span><br><span class="line">  id: data-disk</span><br><span class="line">  match:</span><br><span class="line">    model: Seagate</span><br></pre></td></tr></table></figure>
<strong>分区&#x2F;逻辑卷扩展</strong><br>curtin中的分区或逻辑卷的大小指定为字节数。自动安装配置更加灵活：<br>可以使用安装程序用户界面中支持的“1G”、“512M”语法指定大小<br>可以将大小指定为包含磁盘（或RAID）的百分比，例如“50%”<br>对于为特定设备指定的最后一个分区，可以将大小指定为“-1”以指示该分区应填充剩余空间。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">- type: partition</span><br><span class="line">  id: boot-partition</span><br><span class="line">  device: root-disk</span><br><span class="line">  size: 10%</span><br><span class="line">- type: partition</span><br><span class="line">  id: root-partition</span><br><span class="line">  size: 20G</span><br><span class="line">- type: partition</span><br><span class="line">  id: data-partition</span><br><span class="line">  device: root-disk</span><br><span class="line">  size: -1</span><br></pre></td></tr></table></figure>
<strong>identity</strong><br>名称：身份<br>类型：映射，参看下面<br>默认值：无<br>是否可交互：可<br>配置系统的初始用户。这是唯一必须存在的配置关键字（除非存在用户数据部分，在这种情况下它是可选的）。<br>可以包含关键字的映射，所有关键字都采用字符串值：<br>realname：实际名<br>username：用户名<br>hostname： 主机名<br>password：密码，加密的。这是与 sudo 一起使用时所必需的，即使配置了 SSH 访问。</li>
</ul>
<p><strong>ssh</strong><br>名称： SSH 服务<br>类型：映射，参看下面<br>默认值：参看下面<br>是否可交互：可<br>为已安装的系统配置 SSH 服务。可以包含关键字的映射：<br>install-server<br>名称：安装 SSH 服务<br>类型：布尔型<br>默认值：false，不安装<br>是否安装 OpenSSH 服务。<br>authorized-keys<br>名称： SSH 认证公钥<br>类型：字符串列表<br>默认值：[]<br>要安装在初始用户帐户中的 SSH 公钥列表，方便其他主机采用密钥通过 SSH 访问该主机。<br>allow-pw<br>名称：是否允许密码<br>类型：布尔型<br>默认值：当 authorized_keys 为空时为真 true ，否则为否 false</p>
<p><strong>snaps</strong><br>名称：snap包<br>类型：列表<br>默认值：不安装其他snap<br>是否可交互：可<br>要安装的snap包列表。每个snap都表示为具有必需的关键字 name 和可选的关键字 chanel （默认为 stable ）和 classic （经典默认为 false ）的映射。如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">snaps:</span><br><span class="line">    - name: etcd</span><br><span class="line">      channel: edge</span><br><span class="line">      classic: false</span><br></pre></td></tr></table></figure>
<p><strong>debconf-selections</strong><br>名称：采用 debconf 设置包选择<br>类型：字符串<br>默认值：无<br>是否可交互：否<br>安装程序将使用 debconf 设置选择值更新目标。用户需要熟悉软件包 debconf 选项。</p>
<p><strong>packages</strong><br>名称：软件包<br>类型：列表<br>默认值：无软件包<br>是否可交互：否<br>要安装到目标系统中的软件包列表。更准确地说，是传递给命令 apt-get install 的字符串列表，因此这包括任务选择（ dns-server^ ）和安装特定版本的包（ my-package&#x3D;1-1 ）。</p>
<p><strong>user-data</strong><br>名称：用户数据<br>类型：映射<br>默认值：{}<br>是否可交互：否<br>提供 cloud-init 用户数据，它将与安装程序生成的用户数据 user-data 合并。如果您提供此信息，则无需提供身份 identity 部分（但您有责任确保您可以登录到已安装的系统！）。</p>
<p><strong>转换preceed文件</strong><br>安装<code>autoinstall-generator</code>包<br>执行<code>autoinstall-generator my-preseed.txt my-cloud-config.yaml --cloud</code></p>
<h3 id="Linux-iPXE-preseed"><a href="#Linux-iPXE-preseed" class="headerlink" title="Linux+iPXE+preseed"></a>Linux+iPXE+preseed</h3><h4 id="安装软件包-1"><a href="#安装软件包-1" class="headerlink" title="安装软件包"></a>安装软件包</h4><p>需要安装DHCP, TFTP和DNS服务器以实现PXE，<code>dnsmasq</code>包恰好同时实现了三种服务。<br>需要iPXE的引导文件，在 <a target="_blank" rel="noopener" href="https://boot.ipxe.org/">iPXE.org</a> 下载<code>undionly.kpxe</code>和<code>ipxe.efi</code>，也可直接执行<br><code>wget https://boot.ipxe.org/undionly.kpxe</code><br><code>wget https://boot.ipxe.org/ipxe.efi</code><br>需要安装HTTP服务器以传输镜像，<code>nginx</code>和<code>apache2</code>都可以，也可以使用<code>python3 -m http.server [port] [--bind IP] --directory|-d /var/www/html/</code>的简易服务器(此服务器默认使用当前目录，所以需要手动指定资源目录)。</p>
<h4 id="创建TFTP文件夹-1"><a href="#创建TFTP文件夹-1" class="headerlink" title="创建TFTP文件夹"></a>创建TFTP文件夹</h4><p>在符合规范的目录下创建tftp服务的根目录，目录下结构应当如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tftp</span><br><span class="line">├── undionly.kpxe</span><br><span class="line">├── boot.ipxe</span><br><span class="line">└── ipxe.efi</span><br></pre></td></tr></table></figure>
<h4 id="配置DNSMASQ-1"><a href="#配置DNSMASQ-1" class="headerlink" title="配置DNSMASQ"></a>配置DNSMASQ</h4><p>同上，不解释了。不同之处在于这次同时支持不同架构的计算机。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"># 配置上游 DNS 服务器地址</span><br><span class="line">server=114.114.114.144</span><br><span class="line"></span><br><span class="line"># 指定服务的网卡</span><br><span class="line">interface=enp2s0,lo</span><br><span class="line"></span><br><span class="line"># 绑定端口</span><br><span class="line">bind-interfaces</span><br><span class="line"></span><br><span class="line"># 设置 DHCP 分发 IP 端范围、地址掩码、IP 地址有效时间</span><br><span class="line">dhcp-range=192.168.1.100,192.168.1.150,255.255.255.0,12h</span><br><span class="line"># 或者使用CIDR</span><br><span class="line">dhcp-range=192.168.1.100/24,192.168.1.150/24,12h</span><br><span class="line"></span><br><span class="line"># 匹配BIOS架构的客户端</span><br><span class="line">dhcp-match=set:bios,option:client-arch,0</span><br><span class="line"></span><br><span class="line"># 匹配iPXE客户端，其特征码为175</span><br><span class="line">dhcp-match=set:ipxe,175</span><br><span class="line"></span><br><span class="line"># iPXE客户端直接引导iPXE，方括号内容为使用外部TFTP服务器</span><br><span class="line">dhcp-boot=tag:ipxe,boot.ipxe[,,192.168.1.X]</span><br><span class="line"></span><br><span class="line"># 非iPXE的BIOS客户端直接使用undionly.kpxe引导</span><br><span class="line">dhcp-boot=tag:!ipxe,tag:bios,undionly.kpxe[,,192.168.1.X]</span><br><span class="line"></span><br><span class="line"># EFI客户端全部使用ipxe.efi引导</span><br><span class="line">dhcp-boot=tag:!ipxe,tag:!bios,ipxe.efi[,,192.168.1.X]</span><br><span class="line"></span><br><span class="line"># 也可以使用pxe-service，此处不细写了</span><br><span class="line"></span><br><span class="line"># 启用 tftp 服务</span><br><span class="line">enable-tftp</span><br><span class="line"></span><br><span class="line"># 设置 tftp 根路径</span><br><span class="line">tftp-root=/srv/tftp</span><br><span class="line"></span><br><span class="line"># 设置日志路径</span><br><span class="line">log-facility=/var/log/dnsmasq.log</span><br></pre></td></tr></table></figure>
<h4 id="创建HTTP资源目录-1"><a href="#创建HTTP资源目录-1" class="headerlink" title="创建HTTP资源目录"></a>创建HTTP资源目录</h4><p>启动HTTP服务<code>systemctl start nginx|apache2</code><br>默认http服务的资源根目录是 <code>/var/www/html</code>，目录下结构应当如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">html/</span><br><span class="line">├── index.html(没用)</span><br><span class="line">├── boot</span><br><span class="line">│   ├── bcd</span><br><span class="line">│   ├── boot.sdi</span><br><span class="line">│   └── boot.wim</span><br><span class="line">└── iso</span><br><span class="line">    └── 镜像名.iso</span><br></pre></td></tr></table></figure>

<ol>
<li>boot目录下为Windows引导文件，详情见之前内容</li>
<li>iso目录存放镜像</li>
</ol>
<h4 id="创建iPXE启动脚本"><a href="#创建iPXE启动脚本" class="headerlink" title="创建iPXE启动脚本"></a>创建iPXE启动脚本</h4><p>创建boot.ipxe后，根据之前说过的格式，写入以下内容：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">#!ipxe</span><br><span class="line"># 设定服务器IP，这里只演示HTTP服务器</span><br><span class="line">set boot-url http://192.168.1.X</span><br><span class="line"></span><br><span class="line">set menu-timeout 5000</span><br><span class="line">isset $&#123;menu-default&#125; || set menu-default exit</span><br><span class="line"></span><br><span class="line">######## MAIN MENU ###################</span><br><span class="line">:start</span><br><span class="line">menu PXE Boot Menu</span><br><span class="line">item shell    iPXE shell</span><br><span class="line">item ubuntu    Ubuntu autoinstall</span><br><span class="line">item debian    Debian autoinstall</span><br><span class="line">item reboot    Reboot</span><br><span class="line">item exit    Exit to BIOS</span><br><span class="line">choose --default debian --timeout 10000 option &amp;&amp; goto $&#123;option&#125;</span><br><span class="line"></span><br><span class="line">########## UTILITIES ####################</span><br><span class="line">:shell</span><br><span class="line">shell</span><br><span class="line"></span><br><span class="line"># 直接下载</span><br><span class="line">:ubuntu</span><br><span class="line">set mirror https://mirrors.ustc.edu.cn/</span><br><span class="line">set release jammy</span><br><span class="line">cpuid --ext 29 &amp;&amp; set arch amd64 || set arch i386</span><br><span class="line"># 使用url=指定preseed脚本</span><br><span class="line">set base-url $&#123;mirror&#125;/ubuntu/dists/$&#123;release&#125;/main/installer-$&#123;arch&#125;/current/legacy-images/netboot/ubuntu-installer/$&#123;arch&#125;</span><br><span class="line">kernel $&#123;base-url&#125;/linux auto=true url=xxx/ubuntu.cfg keymap=us domain= hostname=ubuntu-server interface=auto netcfg/do_not_use_netplan=true || goto failed</span><br><span class="line">initrd $&#123;base-url&#125;/initrd.gz || goto failed</span><br><span class="line">goto start</span><br><span class="line"></span><br><span class="line"># 本地服务器文件</span><br><span class="line">:debian</span><br><span class="line">cpuid --ext 29 &amp;&amp; set arch amd64 || set arch i386</span><br><span class="line">sanboot $&#123;boot-url&#125;/iso/debian.iso || goto failed</span><br><span class="line">boot || goto failed</span><br><span class="line">goto start</span><br><span class="line"></span><br><span class="line">:reboot</span><br><span class="line">reboot</span><br><span class="line"></span><br><span class="line">:exit</span><br><span class="line">exit</span><br></pre></td></tr></table></figure>
<h4 id="preseed自动安装脚本"><a href="#preseed自动安装脚本" class="headerlink" title="preseed自动安装脚本"></a>preseed自动安装脚本</h4><p>示例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"># 自动设置网络接口</span><br><span class="line">d-i netcfg/choose_interface select auto</span><br><span class="line"># 手动设置网络接口</span><br><span class="line">#d-i netcfg/choose_interface select eth1</span><br><span class="line"># 手动设置网络请先禁用DHCP</span><br><span class="line">#d-i netcfg/disable_dhcp boolean true</span><br><span class="line"># 手动设置网络</span><br><span class="line">d-i netcfg/get_nameservers string 10.0.2.3</span><br><span class="line">d-i netcfg/get_ipaddress string 10.0.2.99</span><br><span class="line">d-i netcfg/get_netmask string 255.255.255.0</span><br><span class="line">d-i netcfg/get_gateway string 10.0.2.2</span><br><span class="line">d-i netcfg/confirm_static boolean true</span><br><span class="line"># 设置主机名和域名</span><br><span class="line">d-i netcfg/get_hostname string babelbox</span><br><span class="line">d-i netcfg/get_domain string unassigned-domain</span><br><span class="line">### 设置镜像源</span><br><span class="line">d-i mirror/country string enter information manually</span><br><span class="line">d-i mirror/http/hostname string 10.0.2.2</span><br><span class="line">d-i mirror/http/directory string /debian</span><br><span class="line">d-i mirror/http/proxy string</span><br><span class="line">### 分区</span><br><span class="line"># 使用单分区</span><br><span class="line">d-i partman-auto/init_automatically_partition select biggest_free</span><br><span class="line">d-i partman-auto/choose_recipe select atomic</span><br><span class="line"># 使用自动分区</span><br><span class="line">d-i partman/choose_partition select finish</span><br><span class="line">d-i partman/confirm boolean true</span><br><span class="line">d-i partman/confirm_nooverwrite boolean true</span><br><span class="line">### 时区设置</span><br><span class="line"># 是否使用UTC</span><br><span class="line">d-i clock-setup/utc boolean true</span><br><span class="line"># 设置时区</span><br><span class="line">d-i time/zone string Asia/Shanghai</span><br><span class="line">### Apt设置</span><br><span class="line"># 是否使用镜像源</span><br><span class="line">d-i apt-setup/use_mirror boolean false</span><br><span class="line">### 用户设置</span><br><span class="line"># root用户设置</span><br><span class="line">d-i passwd/root-password password r00tme</span><br><span class="line">d-i passwd/root-password-again password r00tme</span><br><span class="line"># 普通用户设置</span><br><span class="line">d-i passwd/user-fullname string Debian User</span><br><span class="line">d-i passwd/username string debian</span><br><span class="line">d-i passwd/user-password password r00tme</span><br><span class="line">d-i passwd/user-password-again password r00tme</span><br><span class="line">### GRUB设置</span><br><span class="line">d-i grub-installer/skip boolean false</span><br><span class="line">d-i lilo-installer/skip boolean true</span><br><span class="line">### 包设置</span><br><span class="line">d-i pkgsel/update-policy select none</span><br><span class="line">d-i pkgsel/include string openssh-server vim wget net-tools software-properties-common</span><br><span class="line">d-i pkgsel/upgrade select none</span><br><span class="line">### 完成安装</span><br><span class="line">d-i finish-install/reboot_in_progress note</span><br></pre></td></tr></table></figure>
<p>在引导菜单中使用url&#x3D;指定preseed脚本</p>
<h4 id="kickstart脚本"><a href="#kickstart脚本" class="headerlink" title="kickstart脚本"></a>kickstart脚本</h4><p>在RHEL系安装完成后，kickstart脚本会自动生成于&#x2F;root&#x2F;anaconda-ks.cfg。<br>在其他系统下，可以安装<code>system-config-kickstart</code>包，然后按照图形界面进行设置后生成文件。<br>在引导选项中使用ks&#x3D;指定kickstart脚本。</p>
<h3 id="Docker-Cobbler"><a href="#Docker-Cobbler" class="headerlink" title="Docker+Cobbler"></a>Docker+Cobbler</h3><p>Cobbler 是一个 Linux 服务器安装的服务，可以通过网络启动 (PXE) 的方式来快速安装、重装物理服务器和虚拟机，同时还可以管理 DHCP，DNS 等。<br>Cobbler集成以下服务</p>
<ul>
<li>PXE 服务支持</li>
<li>DHCP 服务管理(可选dhcp-server, dnsmasq和kea)</li>
<li>DNS 服务管理(可选bind或dnsmasq)</li>
<li>IPMI 电源管理</li>
<li>Kickstart 服务支持</li>
<li>YUM 仓库管理</li>
<li>TFTP (PXE 启动时需要)</li>
<li>Apache httpd(提供 kickstart 的安装源，并提供定制化的 kickstart 配置)<br>Cobbler可以使用命令行方式管理，也提供了基于Web的界面管理工具（cobbler-web），还提供了API接口，可以方便二次开发使用。</li>
</ul>
<p>Cobbler的配置结构基于一组注册的对象。每个对象表示一个与另一个实体相关联的实体。当一个对象指向另一个对象时，它就继承了被指向对象的数据，并可覆盖或添加更多特定信息。<br>发行版(distros)： 表示一个操作系统。它承载了内核和initrd的信息，以及内核参数等其他数据。<br>配置文件(profiles)：包含一个发行版、一个kickstart文件以及可能的存储库，还包括更多特定的内核参数等其他数据。<br>系统(systems)：表示要配给的机器。它包括一个配置文件或一个镜像、IP和MAC地址、电源管理（地址、凭据、类型）以及更为专业的数据等信息。<br>镜像(images)：可以替换一个保函不屑于此类别的文件的发行版对象（例如，无法分为内核和initrd的对象）。</p>
<p>Server端</p>
<ul>
<li>启动<code>Cobbler</code>服务</li>
<li>进行<code>Cobbler</code>错误检查，执行<code>cobbler check</code>命令</li>
<li>进行配置同步，执行<code>cobbler sync</code>命令</li>
<li>复制相关启动文件到<code>TFTP</code>目录中</li>
<li>启动<code>DHCP</code>服务，提供地址分配</li>
<li><code>DHCP</code>服务分配IP地址</li>
<li><code>TFTP</code>传输启动文件</li>
<li><code>Server</code>端接收安装信息</li>
<li><code>Server</code>端发送<code>ISO</code>镜像与<code>Kickstart</code>文件</li>
</ul>
<p>Client端</p>
<ul>
<li>客户端以<code>PXE</code>模式启动</li>
<li>客户端获取<code>IP</code>地址</li>
<li>通过<code>TFTP</code>服务器获取启动文件</li>
<li>进入<code>Cobbler</code>安装选择界面</li>
<li>根据配置信息准备安装系统</li>
<li>加载<code>Kickstart</code>文件</li>
<li>传输系统安装的其它文件</li>
<li>进行安装系统</li>
</ul>
<h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><p>不幸的是，Deb系的官方源中没有Cobbler。所以要么从源码构建，要么使用Docker。<br>RHEL系安装：<br><code>dnf module enable cobbler:3</code><br><code>dnf install cobbler</code></p>
<p>Docker安装：<br><code>docker pull tartarefr/docker-cobbler</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"># 挂载镜像，此处以centos为例，挂载点会与容器共享</span><br><span class="line">sudo mkdir /mnt/centos</span><br><span class="line">sudo mount -o ro /path/to/isos/CentOS-7-x86_64-DVD-1804.iso /mnt/centos</span><br><span class="line"></span><br><span class="line"># 创建cobbler http资源目录卷</span><br><span class="line">docker volume create cobbler_www</span><br><span class="line"># 创建cobbler tftp根目录卷</span><br><span class="line">docker volume create cobbler_tftp</span><br><span class="line"># 创建cobbler配置文件目录卷</span><br><span class="line">docker volume create cobbler_config</span><br><span class="line"># 创建cobbler备份目录卷</span><br><span class="line">docker volume create cobbler_backup</span><br><span class="line"># 创建cobbler运行时卷</span><br><span class="line">docker volume create cobbler_run</span><br><span class="line"></span><br><span class="line">HOST_IP_ADDR: 主机的IP，用于cobbler API，必要</span><br><span class="line">HOST_HTTP_PORT: 主机的HTTP端口，用于容器中的cobbler API，默认为80</span><br><span class="line">DEFAULT_ROOT_PASSWD: 默认root密码，默认为cobbler，必要</span><br><span class="line">COBBLER_WEB_USER: cobbler_web的用户，默认为cobbler，可选</span><br><span class="line">COBBLER_WEB_PASSWD: cobbler_web的用户密码，默认为cobbler，可选</span><br><span class="line">COBBLER_WEB_REALM: cobbler_web的领域，默认为Cobbler，可选</span><br><span class="line">COBBLER_LANG: 语言，默认为fr_FR，可选</span><br><span class="line">COBBLER_KEYBOARD: 键盘类型，默认为fr-latin-9，可选</span><br><span class="line">COBBLER_TZ: 时区，默认为Europe/Paris，可选</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">docker run -itd \</span><br><span class="line">    -v cobbler_www:/var/www/cobbler:Z \</span><br><span class="line">    -v cobbler_tftp:/var/lib/tftp:Z \</span><br><span class="line">    -v cobbler_config:/var/lib/cobbler/config:Z \</span><br><span class="line">    -v cobbler_backup:/var/lib/cobbler/backup:Z \</span><br><span class="line">    -v cobbler_run:/var/run/supervisor:Z \</span><br><span class="line">    -v /mnt/centos:/mnt:Z \</span><br><span class="line">    -e DEFAULT_ROOT_PASSWD=cobbler \</span><br><span class="line">    -e HOST_IP_ADDR=$(hostname --ip-address | awk &#x27;&#123;print $1&#125;&#x27;) \</span><br><span class="line">    -e HOST_HTTP_PORT=80 \</span><br><span class="line">    -e COBBLER_WEB_USER=cobbler \</span><br><span class="line">    -e COBBLER_WEB_PASSWD=cobbler \</span><br><span class="line">    -e COBBLER_WEB_REALM=Cobbler \</span><br><span class="line">    -e COBBLER_LANG=en_US \</span><br><span class="line">    -e COBBLER_KEYBOARD=us \</span><br><span class="line">    -e COBBLER_TZ=Asia/Shanghai \</span><br><span class="line">    -p 69:69/udp \</span><br><span class="line">    -p 80:80 \</span><br><span class="line">    -p 443:443 \</span><br><span class="line">    -p 25151:25151 \</span><br><span class="line">    --name cobbler \</span><br><span class="line">    cobbler:latest</span><br></pre></td></tr></table></figure>
<p>导入测试镜像，在容器中执行<code>cobbler image add --name=memtest86+ --file=/boot/memtest86+-5.01 --image-type=direct</code><br>导入CentOS镜像，在容器中执行<code>cobbler import --path=/mnt --name=CentOS-7-x86_64</code><br>设置CentOS镜像，在容器中执行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cobbler profile add --name=CentOS-7-x86_64-Desktop --distro=CentOS-7-x86_64 --kickstart=/var/lib/cobbler/kickstarts/sample_end.ks --virt-file-size=12 --virt-ram=2048</span><br><span class="line"></span><br><span class="line">cobbler profile edit --name CentOS-7-x86_64-Desktop --ksmeta=&quot;type=desktop&quot;</span><br></pre></td></tr></table></figure>
<h4 id="文件内容"><a href="#文件内容" class="headerlink" title="文件内容"></a>文件内容</h4><p>Cobbler的文件组成如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"># 配置目录</span><br><span class="line">/etc/cobbler                  # 配置文件目录</span><br><span class="line">/etc/cobbler/settings         # cobbler主配置文件，这个文件是YAML格式</span><br><span class="line">/etc/cobbler/dhcp.template    # DHCP服务的配置模板</span><br><span class="line">/etc/cobbler/tftpd.template   # tftp服务的配置模板</span><br><span class="line">/etc/cobbler/rsync.template   # rsync服务的配置模板</span><br><span class="line">/etc/cobbler/iso              # iso模板配置文件目录</span><br><span class="line">/etc/cobbler/pxe              # pxe模板文件目录</span><br><span class="line">/etc/cobbler/power            # 电源的配置文件目录</span><br><span class="line">/etc/cobbler/users.conf       # Web服务授权配置文件</span><br><span class="line">/etc/cobbler/users.digest     # 用于web访问的用户名密码配置文件</span><br><span class="line">/etc/cobbler/dnsmasq.template # DNS服务的配置模板</span><br><span class="line">/etc/cobbler/modules.conf     # Cobbler模块配置文件</span><br><span class="line"></span><br><span class="line"># 数据目录</span><br><span class="line">/var/lib/cobbler              # Cobbler数据目录</span><br><span class="line">/var/lib/cobbler/config       # 用于存放distros,system,profiles等信息配置文件</span><br><span class="line">/var/lib/cobbler/triggers/    # 用于存放用户定义的cobbler命令</span><br><span class="line">/var/lib/cobbler/kickstarts   # 默认存放kickstart文件</span><br><span class="line">/var/lib/cobbler/loaders      # 存放的各种引导程序</span><br><span class="line"></span><br><span class="line"># 镜像目录</span><br><span class="line">/var/www/cobbler              # 系统安装镜像目录</span><br><span class="line">/var/www/cobbler/ks_mirror    # 导入的发行版系统镜像列表</span><br><span class="line">/var/www/cobbler/images       # 导入的系统镜像的kernel和initrd启动文件</span><br><span class="line">/var/www/cobbler/repo_mirror  # yum源存储目录</span><br><span class="line"></span><br><span class="line"># 日志目录</span><br><span class="line">/var/log/cobbler              # 日志目录</span><br><span class="line">/var/log/cobbler/install.log  # 客户端系统安装日志</span><br><span class="line">/var/log/cobbler/cobbler.log  # cobbler日志</span><br></pre></td></tr></table></figure>
<h4 id="cobbler命令"><a href="#cobbler命令" class="headerlink" title="cobbler命令"></a>cobbler命令</h4><ul>
<li><code>cobbler check</code> 核对当前设置是否有问题</li>
<li><code>cobbler list</code> 列出所有的Cobbler元素</li>
<li><code>cobbler report</code> 列出元素的详细信息</li>
<li><code>cobbler setting edit --name=配置项 --value=配置内容</code> 修改Cobbler配置，对应&#x2F;etc&#x2F;cobbler&#x2F;settings中的内容</li>
<li><code>cobbler sync </code>同步配置到数据目录，更改配置后最好都要执行下</li>
<li><code>cobbler reposync</code> 同步yum仓库到与本地一致</li>
<li><code>cobbler distro</code> 查看导入的发行版系统信息</li>
<li><code>cobbler system</code> 查看添加的系统信息</li>
<li><code>cobbler profile</code> 查看配置信息</li>
<li><code>cobbler get-loaders</code> 下载bootloader</li>
<li><code>cobbler import --name=centos --path=/media/cdrom --arch=x86_64</code> 导入系统</li>
<li><code>cobbler profile edit --name=centos --distro=centos --kickstart= /var/lib/cobbler/kickstarts/centos.cfg</code> 修改profile，对应profile report中的内容</li>
</ul>
<h4 id="配置流程"><a href="#配置流程" class="headerlink" title="配置流程"></a>配置流程</h4><ol>
<li>配置&#x2F;etc&#x2F;cobbler&#x2F;settings，设置服务器IP和TFTP服务器IP<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">server: 192.168.1.X</span><br><span class="line">next_server: 192.168.1.X</span><br></pre></td></tr></table></figure>
或直接执行<code>cobbler setting edit --name=server --value=192.168.1.X</code><br><code>cobbler setting edit --name=next_server --value=192.168.1.X</code></li>
<li>下载bootloader文件<br>执行<code>cobbler get-loaders</code>，也可以手动下载后放入<code>/var/lib/cobbler/loaders</code><br><code>cat /var/lib/tftpboot/pxelinux.cfg/default</code>进行检查</li>
<li>生成密码<br>执行<code>openssl passwd -1</code>，使用MD5算法生成加密密码，写入<code>/etc/cobbler/settings</code><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">default_password_crypted: &quot;password&quot;</span><br></pre></td></tr></table></figure></li>
<li>修改<code>/etc/xinetd.d/xxx</code>中的服务，将需要的服务的<code>disable=</code>改为<code>no</code></li>
<li>根据需要安装额外包如<code>pykickstart</code>，<code>fence-agents</code>，<code>debmirror</code>，解决check出的剩余错误</li>
</ol>
<p>settings文件全部内容</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br></pre></td><td class="code"><pre><span class="line"># 不允许将同样的hostname配置到多个操作系统，如果为#将不利于局域网内的域名解析。</span><br><span class="line">allow_duplicate_hostnames:0</span><br><span class="line"># 不允许将同样的IP地址配置到多个操作系统，如果为#将会造成局域网内DHCP和DNS服务冲突。</span><br><span class="line">allow_duplicate_ips:0</span><br><span class="line"># 不允许将同样的MAC地址配置到多个操作系统，如果为#将会造成局域网内DHCP和DNS服务冲突。</span><br><span class="line">allow_duplicate_macs:0</span><br><span class="line"># 允许被安装操作系统客户机将系统安装信息返回到Cobbler Server的/var/log/cobbler/anamon/目录下，0为关闭</span><br><span class="line">anamon_enabled:1</span><br><span class="line"># 在此修改认证模块，默认为login</span><br><span class="line">authn_pam_service:&quot;login&quot;</span><br><span class="line"># 关闭操作系统安装结束后构建报表，1为开起</span><br><span class="line">build_reporting_enabled:0</span><br><span class="line"></span><br><span class="line"># 报表邮件发件人，可选</span><br><span class="line">build_reporting_sender:&quot;&quot;</span><br><span class="line"># 报表发送地址列表</span><br><span class="line">build_reporting_email:[&#x27;root@localhost&#x27;]</span><br><span class="line"># 发送报表邮件的SMTP服务器地址</span><br><span class="line">build_reporting_smtp_server:172.16.2.232</span><br><span class="line"># 报表邮件的主题</span><br><span class="line">build_reporting_subject:&quot;&quot;</span><br><span class="line"></span><br><span class="line"># cheetah(一个用python写的开源的模板引擎和代码生成工具)模块导入白名单。配置白名单后cheetah将可以使用里面相关模块。这是一个有用的高级功能，如果允许cheetah导入任意模块，这系统将会有安全隐患。</span><br><span class="line">cheetah_import_whitelist:-&quot;random&quot;-&quot;re&quot;-&quot;time&quot;</span><br><span class="line"># 使用createrepo命令的reposync期间创建新存储库的默认选项。如果createrepo版本大于或等于0.4.10，使用此参数将大幅缩短cobbler reposync命令执行的时间</span><br><span class="line">createrepo_flags:&quot;-c cache -s sha&quot;</span><br><span class="line"></span><br><span class="line"># 默认的kickstart文件，当被安装操作系统服务器没有指定使用kickstart文件时，将使用此文件。</span><br><span class="line">default_kickstart:/var/lib/cobbler/kickstarts/default.ks   </span><br><span class="line"># 默认的DNS服务器地址，当被安装操作系统服务器没有指定使用DNS服务器地址时候，将使用此地址</span><br><span class="line">default_name_servers:[]</span><br><span class="line"># 分配给新创建对象的所有者列表，仅用于Cobbler Web。</span><br><span class="line">default_ownership:&quot;admin&quot;</span><br><span class="line"># 被安装操作系统服务器的root密码(默认为cobbler)。使用”openssl passwd -1″命令生成</span><br><span class="line">default_password_crypted: cloud$b#gaBwSH/Z8OiOGobbx7H </span><br><span class="line"># 默认解析kickstart和snippets使用的类型为cheetah，cobbler支持cheetah和jinja2，如果修改将修改cobbler所有模板的相关需解析项。</span><br><span class="line">default_template_type:&quot;cheetah&quot;</span><br><span class="line"></span><br><span class="line"># 配置默认的虚拟桥接网卡，也可配置为virbr0</span><br><span class="line">default_virt_bridge: xenbr0</span><br><span class="line"># 虚拟机默认磁盘空间(GB)</span><br><span class="line">default_virt_file_size:5</span><br><span class="line"># 虚拟机默认内存大小(MB)</span><br><span class="line">default_virt_ram:#2</span><br><span class="line"># 默认的虚拟化类型为xen(RHEL6以后默认使用KVM)</span><br><span class="line">default_virt_type: xenpv</span><br><span class="line"># 不允许gpxe启动。(gPXE支持通过HTTP、FTP和NFS方式传输文件)通常用于ESXi和XenServer的安装</span><br><span class="line">enable_gpxe:0</span><br><span class="line"># 开启在被安装操作系统pxe启动时，使用菜单方式选择安装操作系统，该选项在Cobbler system那默认关闭。</span><br><span class="line">enable_menu:1</span><br><span class="line"></span><br><span class="line"># 不允许cobbler安装和配置func(一个强大的远程控制和脚本执行工具)。1为允许</span><br><span class="line">func_auto_setup:0</span><br><span class="line"># func server地址，默认为其官网主页</span><br><span class="line">func_master: overlord.example.org</span><br><span class="line"></span><br><span class="line"># Apache监听端口</span><br><span class="line">http_port:80</span><br><span class="line"># 内核选项，在每一个使用cobbler安装的系统都存在以下选项</span><br><span class="line">kernel_options:    ksdevice: bootif    lang:&#x27; &#x27;    text:~</span><br><span class="line"># 内核选项s390x架构，和内核选项一样</span><br><span class="line">kernel_options_s390x:    RUNKS:1    ramdisk_size:40000    root:/dev/ram0    ro:~    ip: off    vnc:~</span><br><span class="line"></span><br><span class="line"># 使用LDAP身份验证的服务器地址</span><br><span class="line">ldap_server:172.16.2.232</span><br><span class="line"># 使用LDAP身份认证的DN</span><br><span class="line">ldap_base_dn:&quot;DC=example,DC=com&quot;</span><br><span class="line"># 连接到LDAP服务器时所使用的端口。如果启用了TLS和这个端口389是默认,Cobbler在内部转换为SSL的636端口</span><br><span class="line">ldap_port:389</span><br><span class="line"># 允许LDAP身份验证使在SSL/TLS加密连接</span><br><span class="line">ldap_tls:1</span><br><span class="line"># 允许LDAP身份验证模块使用一个匿名绑定连接到LDAP服务器。</span><br><span class="line">ldap_anonymous_bind:1</span><br><span class="line"># 用于绑定到LDAP服务器进行身份验证使用的DN，当ldap_anonymous_bind=0才会生效。</span><br><span class="line">ldap_search_bind_dn:&#x27;&#x27;</span><br><span class="line"># 用于绑定到LDA服务器进行身份验证使用的密码，当ldap_anonymous_bind=0才会生效。</span><br><span class="line">ldap_search_passwd:&#x27;&#x27;</span><br><span class="line"># 用于搜索查询LDAP服务器时使用的前缀。</span><br><span class="line">ldap_search_prefix:&#x27;uid=&#x27;</span><br><span class="line"></span><br><span class="line"># 所有对象列表的默认管理类名。用于集成一个配置管理系统，例如Puppet。</span><br><span class="line">mgmt_classes:[]mgmt_parameters:   from_cobbler:1</span><br><span class="line"># 允许被安装操作系统的服务器，在安装操作系统时安装和配置Puppet工具。0为不允许。</span><br><span class="line">puppet_auto_setup:1</span><br><span class="line"># 允许Cobbler使用Snipperts将客户操作系统自动注册到Puppet Master。</span><br><span class="line">sign_puppet_certs_automatically:1</span><br><span class="line"># Puppetca命令的路径，用于Cobbler为新安装操作系统时自动注册和自动清理注册信息。</span><br><span class="line">puppetca_path:&quot;/usr/bin/puppet&quot;</span><br><span class="line"># 自动清理老的认证信息(当节点有重新安装操作系统时，会触发puppet master清理对应的认证信息)。</span><br><span class="line">remove_old_puppet_certs_automatically:1</span><br><span class="line"></span><br><span class="line"># 允许Cobbler接管DHCP服务。这意味着它会根据模板自动生成dhcp配置文件。</span><br><span class="line">manage_dhcp:1</span><br><span class="line"># 允许Cobbler接管DNS服务。并不重要。</span><br><span class="line">manage_dns:0</span><br><span class="line"># 设置绑定的chroot路径，默认为空，自动检测。</span><br><span class="line">bind_chroot_path:&quot;&quot;</span><br><span class="line"># DNS服务的IP地址</span><br><span class="line">bind_master:127.0.0.1</span><br><span class="line"># 允许Cobbler接管tftp服务。必须。</span><br><span class="line">manage_tftpd:1</span><br><span class="line"># 允许Cobbler接管rsync服务。并不重要。</span><br><span class="line">manage_rsync:1</span><br><span class="line"></span><br><span class="line"># 如果允许Cobbler接管DNS服务，则以下为配置DNS解析管理区域列表。</span><br><span class="line">manage_forward_zones:[&#x27;huacloud.demo&#x27;]manage_reverse_zones:[]</span><br><span class="line"># 如果允许Cobbler接管DHCP服务，这个IP地址将传送给被安装操作系统在PXE启动时使用。如果地址错误，则会导致Tftp时提示timeout错误。</span><br><span class="line">next_server:172.16.2.232</span><br><span class="line"># Cobbler使用电源管理工具时使用的类型，默认为ipmitools工具。</span><br><span class="line">power_management_default_type:&#x27;ipmitool&#x27;</span><br><span class="line"># 用于发送电源管理功能到客户机的模板路径。</span><br><span class="line">power_template_dir:&quot;/etc/cobbler/power&quot;</span><br><span class="line"># 客户机只安装一次操作系统，再次开机时不进入PXE，重装需要 Cobbler system 中使用 netboot-enabled 指定。</span><br><span class="line">pxe_just_once:1</span><br><span class="line"># 如果允许Cobbler接管Tftp服务，这个目录包含模板用于生成PXE启动配置文件。</span><br><span class="line">pxe_template_dir:&quot;/etc/cobbler/pxe&quot;</span><br><span class="line"></span><br><span class="line"># 系统控制台路径，主要用于清除日志和消息。</span><br><span class="line">consoles:&quot;/var/consoles&quot;</span><br><span class="line"># 是否允许将红帽管理平台添加到Cobbler中。默认“off”关闭，“hosted”使用红帽网络，“site”使用红帽Satellite Server和Spacewalk服务器。</span><br><span class="line">redhat_management_type:&quot;off&quot;</span><br><span class="line"># 如果允许使用红帽管理平台，在此配置默认RHN服务器，用于认证和和其他服务。</span><br><span class="line">redhat_management_server:172.16.2.232</span><br><span class="line"># 在此填写红帽注册密钥。</span><br><span class="line">redhat_management_key:&quot;&quot;</span><br><span class="line"># 不允许cobbler接管红帽管理平台</span><br><span class="line">redhat_management_permissive:0</span><br><span class="line"># 不允许使用/usr/bin/cobbler-register远程添加system信息，以及不允许注册的新硬件系统记录。</span><br><span class="line">register_new_installs:0</span><br><span class="line"># 使用yum命令的reposync时，默认添加的参数，如果不支持以下参数可以修改。</span><br><span class="line">reposync_flags:&quot;-l -m -d&quot;</span><br><span class="line"># 当cobbler sync允许重启DNS和DHCP服务。</span><br><span class="line">restart_dns:1 restart_dhcp:1</span><br><span class="line"># 允许执行/var/lib/cobbler/triggers/install目录下的触发器（脚本）。默认使用root帐号执行。</span><br><span class="line">run_install_triggers:1</span><br><span class="line"># 使用允许将触发器通过使用版本控***务管理，默认使用git，也支持hg。</span><br><span class="line">scm_track_enabled:0 scm_track_mode:&quot;git&quot;</span><br><span class="line"></span><br><span class="line"># Cobbler服务的IP地址。</span><br><span class="line">server:172.16.2.232</span><br><span class="line"># 不允许客户机使用本地主机地址而是通过Cobbler Server的配置，通常</span><br><span class="line">client_use_localhost:0</span><br><span class="line"># Snippets存放路径</span><br><span class="line">snippetsdir:/var/lib/cobbler/snippets</span><br><span class="line"># 不允许Cobbler使用远程的kickstart文件</span><br><span class="line">template_remote_kickstarts:0</span><br><span class="line"># 开启物理服务器启动后重启上面的虚拟机。</span><br><span class="line">virt_auto_boot:1</span><br><span class="line"># Cobbler Web页面存放路径</span><br><span class="line">webdir:/var/www/cobbler</span><br><span class="line"># Cobbler监听的XMLRPC端口。</span><br><span class="line">xmlrpc_port:25151</span><br><span class="line"># 允许系统安装后将自建软件园放到/etc/yum.repo.d/目录下</span><br><span class="line">yum_post_install_mirror:1</span><br><span class="line"># 默认将cobbler的软件园设置到最优先权。</span><br><span class="line">yum_distro_priority:1</span><br><span class="line"># 默认使用yumdownloader命令时，添加–resolve参数</span><br><span class="line">yumdownloader_flags:&quot;--resolve&quot;</span><br><span class="line"># 不允许cobbler将JSON信息写入JSON文件（包含所有数据对象类型），默认的是，将JSON输出到一行。</span><br><span class="line">serializer_pretty_json:0</span><br></pre></td></tr></table></figure>
<ol start="6">
<li>配置DHCP<br>首先修改&#x2F;etc&#x2F;cobbler&#x2F;settings<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">manage_dhcp: 1</span><br></pre></td></tr></table></figure>
总结一下，目前settings一共修改了以下几项：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">server: 192.168.1.X</span><br><span class="line"></span><br><span class="line"># 这个参数重点说明一下：</span><br><span class="line"># 这里指的是TFTP的地址，有些情况下也是DHCP地址；因为DHCP服务器会把这个地址作为DHCP选项(66 Boot Server Host Name, 67 Bootfile Name)一起传送过去；这也是一个对当前DHCP要求的指标之一，如果当前环境中服务器的DHCP软件不支持这个选项，那么就得考虑换一个了。</span><br><span class="line"># 当DHCP服务器同时也是TFTP服务器的话就会和DHCP地址一样。如果两者分离的话就需要在DHCP服务器手动配置一下选项，这里也要指向TFTP服务器的地址</span><br><span class="line">next_server: 192.168.1.X</span><br><span class="line"></span><br><span class="line"># 装系统重启后，不再进入PXE引导菜单，直接引导硬盘的系统。</span><br><span class="line">pxe_just_once: 1</span><br><span class="line"></span><br><span class="line"># 这里是新系统的root密码，使用命令openssl passwd -1创建</span><br><span class="line">default_password_crypted: </span><br><span class="line"></span><br><span class="line"># 这里的管理指的是cobbler对于这些服务的配置文件定义，当使用sync命令同步的时候，会自动根据模板文件覆盖这些服务的配置文件；</span><br><span class="line">manage_dhcp: 1</span><br><span class="line">manage_rsync: 1</span><br></pre></td></tr></table></figure>
或直接执行<code>cobbler setting edit --name=manage_dhcp --value=1</code><br>然后修改cobbler的dhcp模版&#x2F;etc&#x2F;cobbler&#x2F;dhcp.template，不要直接修改dhcp本身的配置文件，因为cobbler会覆盖它们。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">subnet 192.168.1.0 netmask 255.255.255.0 &#123; #这里改为分配的子网和掩码</span><br><span class="line">    # option routers             192.168.1.5;    # 设置网关地址，可选</span><br><span class="line">    # option domain-name-servers 192.168.1.1;    # 设置DNS地址，可选</span><br><span class="line">    option subnet-mask         255.255.255.0;    # IP掩码</span><br><span class="line">    range dynamic-bootp        192.168.2.100 192.168.2.254;    # DHCP的IP范围</span><br><span class="line">    default-lease-time         21600;</span><br><span class="line">    max-lease-time             43200;</span><br><span class="line">    next-server                $next_server;    # 就是settings配置的next_server！</span><br><span class="line">    ...以下不变，省略</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
修改完成后执行<code>cobbler sync</code></li>
</ol>
<h4 id="导入镜像"><a href="#导入镜像" class="headerlink" title="导入镜像"></a>导入镜像</h4><p>将镜像挂载 <code>mount -o ro xxx.iso /media</code><br>导入 </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cobbler import --path=/media --name=xxx --arch=x86_64</span><br><span class="line"># --path 镜像路径</span><br><span class="line"># --name 为安装源定义一个名字</span><br><span class="line"># --arch 指定安装源是32位、64位、ia64, 目前支持的选项有: x86│x86_64│ia64</span><br><span class="line"># 安装源的唯一标示就是根据name参数来定义，如果重复，系统会提示导入失败。</span><br></pre></td></tr></table></figure>
<p>安装成功后，可以在<code>cobbler distro list</code>中看到系统名<br>系统会拷贝到镜像目录<code>/var/www/cobbler/ks_mirror/</code>中，可以进行检查<br>检查镜像信息 <code>cobbler distro report --name=xxx</code><br>检查镜像profile <code>cobbler profile report --name=xxx</code></p>
<h4 id="设置Kickstart"><a href="#设置Kickstart" class="headerlink" title="设置Kickstart"></a>设置Kickstart</h4><p>可以自己编辑创建，也可以使用<code>/var/lib/cobbler/kickstarts/</code>中内置的，默认使用<code>sample_end.ks</code>，可以通过<code>cobbler profile edit --name=xxx --kickstart=/var/lib/cobbler/kickstarts/xxx.ks</code>修改</p>
<h4 id="启动PXE测试"><a href="#启动PXE测试" class="headerlink" title="启动PXE测试"></a>启动PXE测试</h4><p>可以修改<code>/etc/cobbler/pxe/pxedefault.template</code>，改变PXE界面。</p>
<h4 id="设置Web"><a href="#设置Web" class="headerlink" title="设置Web"></a>设置Web</h4><p>cobbler web包名为<code>cobbler_web</code>，安装前请确定django版本对应<br>web链接为<code>http://IP/cobbler_web</code>和<code>https://IP/cobbler_web</code>，默认用户名和密码都是cobbler。可以修改<code>/etc/cobbler/users.conf</code>或<code>/etc/cobbler/users.digest</code>进行自定义用户。<br>修改密码可以通过<code>htdigest /etc/cobbler/users.digest &quot;Cobbler&quot; cobbler</code><br>设置认证模式可以修改<code>/etc/cobbler/modules.conf</code><br>比如，使用authn_configfile</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[authentication]</span><br><span class="line">module=authn_configfile</span><br></pre></td></tr></table></figure>
<p>这种模式下，添加用户使用<code>htdigest [-c] /etc/cobbler/users.digest Cobbler admin</code><br>-c 在添加第一个用户时使用<br>使用authn_pam</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[authentication]</span><br><span class="line">module = authn_pam</span><br></pre></td></tr></table></figure>
<p>此时使用主机上的Linux PAM用户，创建用户只需要在主机上执行useradd，然后在<code>/etc/cobbler/users.conf</code>设置管理员权限</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[admins]</span><br><span class="line">admin = &quot;cobbler&quot;</span><br></pre></td></tr></table></figure>

    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2023/01/02/Git%E6%89%8B%E8%AE%B0/" rel="prev" title="Git手记">
                  <i class="fa fa-angle-left"></i> Git手记
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2023/01/17/Linux%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E9%85%8D%E7%BD%AE%E8%A7%84%E8%8C%83/" rel="next" title="Linux环境变量配置规范">
                  Linux环境变量配置规范 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Molten_Armor</span>
  </div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
