<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"blog.icku.eu.org","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="MKOSI-INITRDmkosi-initrd是使用MKOSI进行initramfs构建的工具。">
<meta property="og:type" content="article">
<meta property="og:title" content="MKOSI笔记">
<meta property="og:url" content="https://blog.icku.eu.org/2024/03/30/MKOSI%E7%AC%94%E8%AE%B0/index.html">
<meta property="og:site_name" content="Thinking Thoughts">
<meta property="og:description" content="MKOSI-INITRDmkosi-initrd是使用MKOSI进行initramfs构建的工具。">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2024-03-29T23:15:56.000Z">
<meta property="article:modified_time" content="2025-10-01T14:12:53.625Z">
<meta property="article:author" content="Kwok &quot;Molten_Armor&quot; Guy">
<meta property="article:tag" content="linux">
<meta property="article:tag" content="systemd">
<meta property="article:tag" content="operating_system">
<meta property="article:tag" content="system">
<meta property="article:tag" content="computer">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://blog.icku.eu.org/2024/03/30/MKOSI%E7%AC%94%E8%AE%B0/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://blog.icku.eu.org/2024/03/30/MKOSI%E7%AC%94%E8%AE%B0/","path":"2024/03/30/MKOSI笔记/","title":"MKOSI笔记"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>MKOSI笔记 | Thinking Thoughts</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Thinking Thoughts</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>







</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#MKOSI-INITRD"><span class="nav-number">1.</span> <span class="nav-text">MKOSI-INITRD</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#MKOSI-SANDBOX"><span class="nav-number">2.</span> <span class="nav-text">MKOSI-SANDBOX</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#MKOSI"><span class="nav-number">3.</span> <span class="nav-text">MKOSI</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85"><span class="nav-number">3.1.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AF%AD%E6%B3%95"><span class="nav-number">3.2.</span> <span class="nav-text">语法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9E%84%E5%BB%BA%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-number">3.3.</span> <span class="nav-text">构建配置文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AD%90%E5%91%BD%E4%BB%A4"><span class="nav-number">3.4.</span> <span class="nav-text">子命令</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%91%BD%E4%BB%A4%E8%A1%8C%E9%80%89%E9%A1%B9"><span class="nav-number">3.5.</span> <span class="nav-text">命令行选项</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9E%84%E5%BB%BA%E9%85%8D%E7%BD%AE"><span class="nav-number">3.6.</span> <span class="nav-text">构建配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Match-%E6%AE%B5%E4%B8%8E-TriggerMatch-%E6%AE%B5"><span class="nav-number">3.6.1.</span> <span class="nav-text">[Match]段与[TriggerMatch]段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%88v20%E4%BB%A5%E4%B8%8A%E7%89%88%E6%9C%AC%EF%BC%89-Include-%E6%AE%B5"><span class="nav-number">3.6.2.</span> <span class="nav-text">（v20以上版本）[Include]段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%88v20%E4%BB%A5%E4%B8%8A%E7%89%88%E6%9C%AC%EF%BC%89-Config-%E6%AE%B5"><span class="nav-number">3.6.3.</span> <span class="nav-text">（v20以上版本）[Config]段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Distribution-%E6%AE%B5"><span class="nav-number">3.6.4.</span> <span class="nav-text">[Distribution]段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Output-%E6%AE%B5"><span class="nav-number">3.6.5.</span> <span class="nav-text">[Output]段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%88v20%E4%BB%A5%E4%B8%8A%E7%89%88%E6%9C%AC%EF%BC%89-Build-%E6%AE%B5"><span class="nav-number">3.6.6.</span> <span class="nav-text">（v20以上版本）[Build]段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Content-%E6%AE%B5"><span class="nav-number">3.6.7.</span> <span class="nav-text">[Content]段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Validation-%E6%AE%B5"><span class="nav-number">3.6.8.</span> <span class="nav-text">[Validation]段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Runtime-%E6%AE%B5%EF%BC%88%E6%97%A7%E7%89%88%E6%9C%AC%E4%B8%BA-Host-%E6%AE%B5%EF%BC%89"><span class="nav-number">3.6.9.</span> <span class="nav-text">[Runtime]段（旧版本为[Host]段）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E5%8C%BA"><span class="nav-number">3.6.10.</span> <span class="nav-text">分区</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B5%84%E6%BA%90%E7%9B%AE%E5%BD%95"><span class="nav-number">3.7.</span> <span class="nav-text">资源目录</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%92%A9%E5%AD%90%E8%84%9A%E6%9C%AC"><span class="nav-number">3.8.</span> <span class="nav-text">钩子脚本</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="nav-number">3.9.</span> <span class="nav-text">执行流程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="nav-number">3.10.</span> <span class="nav-text">最佳实践</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%91%E8%A1%8C%E7%89%88%E6%9C%80%E5%B0%8F%E5%8C%96%E6%9E%84%E5%BB%BA"><span class="nav-number">3.11.</span> <span class="nav-text">发行版最小化构建</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Arch"><span class="nav-number">3.11.1.</span> <span class="nav-text">Arch</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Fedora"><span class="nav-number">3.11.2.</span> <span class="nav-text">Fedora</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CentOS-Rocky"><span class="nav-number">3.11.3.</span> <span class="nav-text">CentOS&#x2F;Rocky</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Debian"><span class="nav-number">3.11.4.</span> <span class="nav-text">Debian</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Ubuntu"><span class="nav-number">3.11.5.</span> <span class="nav-text">Ubuntu</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#OpenSUSE"><span class="nav-number">3.11.6.</span> <span class="nav-text">OpenSUSE</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E4%BE%8B"><span class="nav-number">3.12.</span> <span class="nav-text">实例</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9E%84%E5%BB%BA%E4%B8%80%E4%B8%AAFedora%E5%AE%B9%E5%99%A8%E9%95%9C%E5%83%8F"><span class="nav-number">3.12.1.</span> <span class="nav-text">构建一个Fedora容器镜像</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9E%84%E5%BB%BA%E4%B8%80%E4%B8%AADebian%E5%8F%AF%E5%BC%95%E5%AF%BC%E7%A3%81%E7%9B%98%E9%95%9C%E5%83%8F"><span class="nav-number">3.12.2.</span> <span class="nav-text">构建一个Debian可引导磁盘镜像</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9E%84%E5%BB%BAinitramfs"><span class="nav-number">3.12.3.</span> <span class="nav-text">构建initramfs</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9E%84%E5%BB%BA%E4%B8%80%E4%B8%AAUSI%EF%BC%88UEFI-PE%E7%A8%8B%E5%BA%8F%E5%BD%A2%E5%BC%8F%E7%9A%84%E5%AE%8C%E6%95%B4%E7%B3%BB%E7%BB%9F%E9%95%9C%E5%83%8F%EF%BC%89"><span class="nav-number">3.12.4.</span> <span class="nav-text">构建一个USI（UEFI PE程序形式的完整系统镜像）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9E%84%E5%BB%BA%E4%B8%80%E4%B8%AA%E7%B3%BB%E7%BB%9F%E6%89%A9%E5%B1%95%E9%95%9C%E5%83%8F"><span class="nav-number">3.12.5.</span> <span class="nav-text">构建一个系统扩展镜像</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9E%84%E5%BB%BA%E4%B8%80%E4%B8%AA%E4%B8%8D%E5%8F%AF%E5%8F%98%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F"><span class="nav-number">3.12.6.</span> <span class="nav-text">构建一个不可变操作系统</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9E%84%E5%BB%BA%E4%B8%80%E4%B8%AA%E4%B8%8D%E5%AE%89%E5%85%A8%E7%9A%84-usr%E4%B8%8D%E5%8F%AF%E5%8F%98%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F"><span class="nav-number">3.12.7.</span> <span class="nav-text">构建一个不安全的&#x2F;usr不可变操作系统</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Kwok "Molten_Armor" Guy</p>
  <div class="site-description" itemprop="description">Just another blog about Linux, systemd, and something more.</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">43</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/MoltenArmor" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;MoltenArmor" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:kwokjuy@163.com" title="E-Mail → mailto:kwokjuy@163.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.icku.eu.org/2024/03/30/MKOSI%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Kwok "Molten_Armor" Guy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Thinking Thoughts">
      <meta itemprop="description" content="Just another blog about Linux, systemd, and something more.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="MKOSI笔记 | Thinking Thoughts">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          MKOSI笔记
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-03-30 07:15:56" itemprop="dateCreated datePublished" datetime="2024-03-30T07:15:56+08:00">2024-03-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-10-01 22:12:53" itemprop="dateModified" datetime="2025-10-01T22:12:53+08:00">2025-10-01</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h1 id="MKOSI-INITRD"><a href="#MKOSI-INITRD" class="headerlink" title="MKOSI-INITRD"></a>MKOSI-INITRD</h1><p><code>mkosi-initrd</code>是使用MKOSI进行initramfs构建的工具。</p>
<span id="more"></span>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkosi-initrd [选项]</span><br></pre></td></tr></table></figure>
<p>可用选项有：</p>
<ul>
<li><code>--kernel-version=</code>：使用的内核版本，默认使用<code>$(uname -r)</code>。</li>
<li><code>--format=|-t</code>：输出格式，可选值有<code>cpio</code>或<code>uki</code>，默认使用<code>cpio</code>。</li>
<li><code>-o|--output=</code>：输出文件名前缀，默认为<code>initrd</code>。</li>
<li><code>-O|--output-dir=</code>：输出的目录，默认为工作目录。</li>
<li><code>--debug</code>：Debug输出。</li>
</ul>
<p>它本质上是一个使用了特殊的默认配置的MKOSI Wrapper脚本（见<a target="_blank" rel="noopener" href="https://github.com/systemd/mkosi/blob/main/mkosi/resources/mkosi-initrd/mkosi.conf">mkosi.conf</a>），在执行时，它会获取当前主机的内核版本（或用户指定的内核版本），并将当前内核的<code>/usr/lib/modules/版本号</code>目录映射到镜像中进行构建。</p>
<p>该命令行工具由MKOSI的Pypi包提供，对于发行版来说，它们也可以使用Kernel-install脚本进行集成（参考<a target="_blank" rel="noopener" href="https://github.com/marketplace/actions/setup-mkosi">setup-mkosi</a>）。</p>
<h1 id="MKOSI-SANDBOX"><a href="#MKOSI-SANDBOX" class="headerlink" title="MKOSI-SANDBOX"></a>MKOSI-SANDBOX</h1><p><code>mkosi-sandbox</code>用于在沙箱中执行命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkosi-sandbox [选项] [命令] [参数]</span><br></pre></td></tr></table></figure>
<p>命令默认为<code>bash</code>。</p>
<p>接受的选项有：</p>
<ul>
<li><code>--tmpfs 目录</code>：沙箱中挂载的Tmpfs。</li>
<li><code>--dev 目录</code>：沙箱中创建的Devfs。</li>
<li><code>--proc 目录</code>：沙箱中创建的Procfs。</li>
<li><code>--dir 目录</code>：沙箱中递归创建的目录。</li>
<li><code>--bind|--bind-try|--ro-bind|--ro-bind-try 主机目录 沙箱目录</code>：（只读）绑定挂载到沙箱的目录。</li>
<li><code>--symlink 路径 链接</code>：在沙箱中创建软链接。</li>
<li><code>--write 数据 路径</code>：在沙箱中写入指定文件。</li>
<li><code>--overlay-lowerdir 主机目录</code>：设置下一个Overlayfs的下层目录。</li>
<li><code>--overlay-upperdir 主机目录|tmpfs</code>：设置下一个Overlayfs的上层目录。</li>
<li><code>--overlay-workdir 主机目录</code>：设置下一个Overlayfs挂载的工作目录。</li>
<li><code>--overlay 沙箱目录</code>：在沙箱中挂载Overlayfs。</li>
<li><code>--unsetenv 变量名</code>：在沙箱中去掉环境变量。</li>
<li><code>--setenv 变量名 值</code>：在沙箱中设置环境变量。</li>
<li><code>--chdir 目录</code>：启动沙箱时的工作目录。</li>
<li><code>--same-dir</code>：启动沙箱时的工作目录为当前宿主机所处的目录。</li>
<li><code>--become-root</code>：成为沙箱内的Root用户并获取<code>CAP_SYS_ADMIN</code>，默认为普通用户。</li>
<li><code>--suppress-chown</code>：禁止使用<code>chown()</code>系统调用。</li>
<li><code>--unshare-net</code>：隔离网络命名空间。</li>
<li><code>--unshare-ipc</code>：隔离IPC命名空间。</li>
</ul>
<p>实例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkosi-sandbox --bind / / --same-dir --become-root bash --login</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mkosi-sandbox \</span><br><span class="line">    --ro-bind /usr /usr \</span><br><span class="line">    --symlink usr/bin /bin \</span><br><span class="line">    --symlink usr/bin /bin \</span><br><span class="line">    --symlink usr/lib /lib \</span><br><span class="line">    --symlink usr/lib64 /lib64 \</span><br><span class="line">    --symlink usr/sbin /sbin \</span><br><span class="line">    --dev /dev \</span><br><span class="line">    --proc /proc \</span><br><span class="line">    --tmpfs /tmp \</span><br><span class="line">    --become-root \</span><br><span class="line">    id</span><br></pre></td></tr></table></figure>

<h1 id="MKOSI"><a href="#MKOSI" class="headerlink" title="MKOSI"></a>MKOSI</h1><p>Linux发行版 &#x3D; Base Files(Base Rootfs) + Essential Packages + Package Manager：</p>
<ul>
<li>Debian&#x2F;Ubuntu &#x3D; <code>debootstrap</code>(<code>base-files</code> + <code>base-passwd</code>) + <code>&quot;Essential: yes&quot; Packages</code> + <code>apt</code></li>
<li>Fedora&#x2F;CentOS&#x2F;RHEL &#x3D; <code>yum|dnf --installroot</code>(<code>setup</code> + <code>basesystem</code> + <code>filesystem</code>) + <code>@core Package Group</code> + <code>yum|dnf</code></li>
<li>Arch &#x3D; <code>pacstrap</code>(<code>base</code>) + <code>base Meta Package</code> + <code>pacman</code></li>
<li>Gentoo &#x3D; <code>stage 3 Image</code> + <code>@system Set</code> + <code>emerge</code></li>
</ul>
<p><code>mkosi</code>是建立在<code>dnf --installroot</code>、<code>debootstrap</code>、<code>pacstrap</code>等工具之上的，快速构建客制化的系统镜像并进行测试的工具。</p>
<p>“镜像”在这里是一个<strong>通用概念</strong>，这意味着MKOSI可以生成以下类型的“镜像”：</p>
<ul>
<li>使用GPT分区表的磁盘镜像，可以克隆到磁盘中。</li>
<li>CPIO归档，用于作为initramfs使用。</li>
<li>USI（Unified System Image，即将完整的操作系统打包进UKI的镜像）</li>
<li>Sysext、Confext、Portable Service Image镜像</li>
<li>用于容器的目录树镜像</li>
</ul>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p><code>mkosi</code>在各大发行版的软件源中有提供：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># Debian</span><br><span class="line">apt install mkosi</span><br><span class="line"></span><br><span class="line"># RHEL</span><br><span class="line">dnf install mkosi</span><br></pre></td></tr></table></figure>
<p>也可以使用<code>pip</code>安装：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pipx install git+https://https://github.com/systemd/mkosi.git</span><br></pre></td></tr></table></figure>

<h2 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkosi [选项] 子命令</span><br></pre></td></tr></table></figure>

<h2 id="构建配置文件"><a href="#构建配置文件" class="headerlink" title="构建配置文件"></a>构建配置文件</h2><p><code>mkosi</code>的任何命令都基于特定的规则读取配置文件，优先级顺序分别是：</p>
<ul>
<li>最优先：命令行选项。</li>
<li>当前目录下的<code>mkosi.local.conf</code>配置文件或<code>mkosi.local</code>目录下的配置文件。该文件仅用于本地配置，不应该共享。</li>
<li><code>-C|--directory=</code>指定目录（默认为当前目录）下的<code>mkosi.conf</code>配置文件。</li>
<li><code>--directory=</code>指定目录（默认为当前目录）下的<code>mkosi.conf.d/</code>目录内的配置文件。</li>
<li>用户指定的Profile对应的<code>mkosi.profiles/</code>里面的子目录配置。</li>
<li><code>mkosi.images/</code>里面的子镜像的配置。</li>
</ul>
<h2 id="子命令"><a href="#子命令" class="headerlink" title="子命令"></a>子命令</h2><p><code>mkosi</code>由多种子命令组成，这些命令其实都是一些外部工具的简易接口：</p>
<ul>
<li><code>summary</code>：打印配置文件中定义的配置总结，这也反映了构建时会进行的操作。</li>
<li><code>build</code>：从配置文件中读取配置并开始构建镜像。</li>
<li><code>sysupdate</code>：执行<code>systemd-sysupdate</code>，其中，<code>--transfer-source=</code>设为输出目录（默认为<code>mkosi.output/</code>），<code>--definition=</code>设为<code>SysupdateDirectory=</code>的值（默认为<code>mkosi.sysupdate/</code>），任何子命令之后的参数都会被传递给<code>systemd-sysupdate</code>。<ul>
<li>要求：MKOSI使用的Sysupdate配置中，必须设置<code>PathRelativeTo=explicit</code>和<code>Path=/</code>才能正常使用<code>sysupdate</code>子命令进行更新，这会使得配置中的<code>Path=</code>使用<code>mkosi.output/</code>（或<code>OutputDirectory=</code>指定的目录）作为根。</li>
<li>如果使用了ToolsTree，且存在文件系统中存在<code>/usr/share/factory</code>，那么ToolsTree中必须也存在<code>/usr/share/factory</code>，否则会发生文件系统只读错误，这是因为ToolsTree的<code>/usr</code><a target="_blank" rel="noopener" href="https://github.com/systemd/mkosi/blob/main/mkosi/run.py#L503">在Sandbox中是被只读挂载的</a>，<a target="_blank" rel="noopener" href="https://github.com/systemd/mkosi/blob/main/mkosi/sandbox.py#L488">无法在沙盒中创建<code>/usr/share/factory</code>挂载点</a>。</li>
<li>这同时也意味着，<code>SplitArtifacts=partitions</code>必须启用以对分区进行更新，而且更新内容（分区镜像文件、EFI程序、initramfs）文件名必须与Sysupdate配置中的<code>MatchPattern=</code>匹配。</li>
</ul>
</li>
<li><code>shell</code>：（如果还没有构建）先构建镜像，然后调用<code>systemd-nspawn</code>Chroot到镜像内。<ul>
<li>仅适用于<code>QCow2=no</code>且未压缩的镜像。</li>
</ul>
</li>
<li><code>boot</code>：（如果还没有构建）先构建镜像，然后调用<code>systemd-nspawn</code>以容器形式启动镜像。<ul>
<li>仅适用于<code>QCow2=no</code>且未压缩的镜像。</li>
</ul>
</li>
<li><code>qemu</code>：（如果还没有构建）先构建镜像，然后调用<code>qemu</code>以虚拟机形式启动镜像。<ul>
<li>对于目录树，MKOSI使用<code>virtiofsd</code>引导。</li>
<li><code>ssh</code>：连接到镜像对应的虚拟机。</li>
<li><code>genkey</code>：创建SSH密钥。</li>
</ul>
</li>
<li><code>serve</code>：（如果还没有构建）先构建镜像，然后调用内置的HTTP服务器在<code>8081</code>端口上暴露工作目录。</li>
<li>（仅用于<code>disk</code>镜像）<code>burn 块设备</code>：（如果还没有构建）先构建镜像，然后将镜像扩展到目标块设备的大小，再烧录到指定的块设备上。</li>
<li><code>journalctl</code>：获取镜像内的日志。</li>
<li><code>coredumpctl</code>：获取镜像内的内核转储文件。</li>
<li><code>clean</code>：清理之前的构建产物。</li>
<li><code>bump</code>：刷新<code>mkosi.version</code>文件中的镜像版本。</li>
<li><code>genkey</code>：生成安全启动密钥。</li>
</ul>
<h2 id="命令行选项"><a href="#命令行选项" class="headerlink" title="命令行选项"></a>命令行选项</h2><p>这里提到的命令行选项是和构建配置完全无关的：</p>
<ul>
<li><code>-f|--force</code>：进行指定操作前，不加分辨地重新构建镜像。</li>
<li><code>-B--auto-bump</code>：执行操作后自动刷新版本号。</li>
<li><code>-C|--directory=</code>：指定工作目录，默认为当前工作目录。</li>
<li><code>--debug</code>：启用Debug级输出。</li>
<li><code>--debug-shell</code>：当在镜像中执行命令失败时，启动一个额外的Debug Shell用于排错。</li>
<li><code>--debug-workspace=</code>：执行操作后，指定的临时文件目录内容不会删除。</li>
</ul>
<h2 id="构建配置"><a href="#构建配置" class="headerlink" title="构建配置"></a>构建配置</h2><p>构建配置文件符合<code>.ini</code>格式，每一行都是<code>Key=Value</code>的形式，每一个配置项都有等价的命令行选项，转换方式是<code>SomeSetting</code>到<code>some-setting</code>。</p>
<p>配置中存在以下可用的占位符：</p>
<table>
<thead>
<tr>
<th>含义</th>
<th>占位符</th>
</tr>
</thead>
<tbody><tr>
<td><code>Distribution=</code></td>
<td><code>%d</code></td>
</tr>
<tr>
<td><code>Release=</code></td>
<td><code>%r</code></td>
</tr>
<tr>
<td><code>Architecture=</code></td>
<td><code>%a</code></td>
</tr>
<tr>
<td><code>Format=</code></td>
<td><code>%t</code></td>
</tr>
<tr>
<td><code>Output=</code></td>
<td><code>%o</code></td>
</tr>
<tr>
<td><code>OutputDirectory=</code></td>
<td><code>%O</code></td>
</tr>
<tr>
<td><code>ImageId=</code></td>
<td><code>%i</code></td>
</tr>
<tr>
<td><code>ImageVersion=</code></td>
<td><code>%v</code></td>
</tr>
<tr>
<td><code>Profiles=</code></td>
<td><code>%p</code></td>
</tr>
<tr>
<td>配置文件所在目录</td>
<td><code>%C</code></td>
</tr>
<tr>
<td>工作目录</td>
<td><code>%P</code></td>
</tr>
<tr>
<td>MKOSI的执行目录</td>
<td><code>%D</code></td>
</tr>
<tr>
<td>当前子镜像的镜像名</td>
<td><code>%I</code></td>
</tr>
</tbody></table>
<p>具体的构建配置有：</p>
<h3 id="Match-段与-TriggerMatch-段"><a href="#Match-段与-TriggerMatch-段" class="headerlink" title="[Match]段与[TriggerMatch]段"></a><code>[Match]</code>段与<code>[TriggerMatch]</code>段</h3><p>匹配构建时包含当前配置文件的特定条件。每个配置项除了使用<code>=</code>连接键值对外，还可以使用<code>=|</code>连接键值对，多个使用<code>=</code>连接键值对的配置项之间是逻辑与关系，必须全部满足；多个使用<code>=|</code>连接键值对的配置项之间是逻辑或关系，满足一个即可。</p>
<p>可用配置项有：</p>
<ul>
<li><code>Profiles=</code>：使用的Profile。</li>
<li><code>Distribution=</code>：构建的发行版。</li>
<li><code>Release=</code>：构建的发行版版本。</li>
<li><code>Architecture=</code>：构建的架构。可用的值有<code>alpha</code>、<code>arc</code>、<code>arm</code>、<code>arm64</code>、<code>ia64</code>、<code>loongarch64</code>、<code>mips64-le</code>、<code>mips-le</code>、<code>parisc</code>、<code>ppc</code>、<code>ppc64</code>、<code>ppc64-le</code>、<code>riscv32</code>、<code>riscv64</code>、<code>s390</code>、<code>s390x</code>、<code>tilegx</code>、<code>x86</code>、<code>x86-64</code>。</li>
<li><code>HostArchitecture=</code>：主机的架构。</li>
<li><code>ImageId=</code>：构建的镜像名称。</li>
<li><code>ImageVersion=</code>：构建的镜像版本。</li>
<li><code>Bootable=</code>：构建的镜像是否可引导。</li>
<li><code>Format=</code>：构建的镜像格式。</li>
<li><code>ToolsTreeDistribution=</code>：使用的Tools Tree发行版。</li>
<li><code>PathExists=</code>：主机上存在指定目录。</li>
<li><code>SystemdVersion=</code>：主机上的systemd版本。</li>
</ul>
<p><code>[Match]</code>段之间是纯粹的AND关系，也就是说，不同的<code>[Match]</code>段必须全部满足。而<code>[TriggerMatch]</code>段之间是OR关系，也就是说，不同的<code>[TriggerMatch]</code>段中，只要有一个<code>[TriggerMatch]</code>段满足即可。</p>
<h3 id="（v20以上版本）-Include-段"><a href="#（v20以上版本）-Include-段" class="headerlink" title="（v20以上版本）[Include]段"></a>（v20以上版本）<code>[Include]</code>段</h3><ul>
<li><code>Include=</code>：导入指定的额外配置文件。如果值为<code>mkosi-initrd</code>，那么会使用<code>mkosi-initrd</code>的配置生成initramfs。<ul>
<li>特殊值<code>mkosi-initrd</code>表示<code>mkosi-initrd</code>的配置。</li>
<li>特殊值<code>mkosi-tools</code>表示ToolsTree的配置。</li>
<li>特殊值<code>mkosi-vm</code>表示运行虚拟机时的默认配置。</li>
</ul>
</li>
</ul>
<h3 id="（v20以上版本）-Config-段"><a href="#（v20以上版本）-Config-段" class="headerlink" title="（v20以上版本）[Config]段"></a>（v20以上版本）<code>[Config]</code>段</h3><p>额外配置。</p>
<ul>
<li><code>Profiles=</code>：使用指定的Profile，Profile是<code>mkosi.profiles/</code>目录下保存的一个子工作目录，它支持的内容和MKOSI的主工作目录完全一致（除了不能有<code>mkosi.profiles/</code>目录），会覆盖主工作目录的对应部分。<ul>
<li><strong>Profile通常是让用户通过<code>--profile=</code>命令行选项进行自选的</strong>。它可以用于匹配，因此适合保存相同镜像的不同口味。</li>
<li>Profile并不能修改<code>mkosi.images/</code>中的子镜像的配置。</li>
</ul>
</li>
<li><code>ConfigureScript=</code>：在读取配置文件后立刻执行的脚本。默认为<code>mkosi.configure</code>。</li>
<li><code>MinumumVersion=</code>：要求的最小MKOSI版本号。</li>
<li><code>PassEnvironment=</code>：传递的环境变量，空格分隔。</li>
<li><code>Dependencies=</code>：依赖的子镜像，子镜像是<code>mkosi.images/</code>目录下保存的一个子工作目录，它支持的配置项和MKOSI的主工作目录相比会少一些，如果没有<code>Dependencies=</code>，那么所有子镜像都会在主镜像构建之前自动构建，即<code>Dependencies=*</code>，如果有<code>Dependencies=</code>，那么只构建依赖的镜像。<ul>
<li>子镜像不接受的配置项有：</li>
<li><code>Architecture=</code></li>
<li><code>BuildDirectory=</code></li>
<li><code>BuildSources=</code></li>
<li><code>BuildSourcesEphemeral=</code></li>
<li><code>CacheDirectory=</code></li>
<li><code>CacheOnly=</code></li>
<li><code>Distribution=</code></li>
<li><code>ExtraSearchPaths=</code></li>
<li><code>Incremental=</code></li>
<li><code>LocalMirror=</code></li>
<li><code>Mirror=</code></li>
<li><code>OutputDirectory=</code></li>
<li><code>OutputMode=</code></li>
<li><code>PackageCacheDirectory=</code></li>
<li><code>PackageDirectories=</code></li>
<li><code>Profiles=</code></li>
<li><code>ProxyClientCertificate=</code></li>
<li><code>ProxyClientKey=</code></li>
<li><code>ProxyExclude=</code></li>
<li><code>ProxyPeerCertificate=</code></li>
<li><code>ProxyUrl=</code></li>
<li><code>Release=</code></li>
<li><code>RepartOffline=</code></li>
<li><code>Repositories=</code></li>
<li><code>RepositoryKeyCheck=</code></li>
<li><code>SandboxTrees=</code></li>
<li><code>SourceDateEpoch=</code></li>
<li><code>ToolsTree=</code></li>
<li><code>ToolsTreeCertificates=</code></li>
<li><code>UseSubvolumes=</code></li>
<li><code>VerityCertificate=</code></li>
<li><code>VerityKey=</code></li>
<li><code>VolatilePackageDirectories=</code></li>
<li><code>WithNetwork=</code></li>
<li><code>WithTests</code></li>
<li><code>WorkspaceDirectory=</code></li>
</ul>
</li>
</ul>
<h3 id="Distribution-段"><a href="#Distribution-段" class="headerlink" title="[Distribution]段"></a><code>[Distribution]</code>段</h3><p>发行版配置。</p>
<ul>
<li><code>Distribution=</code>：使用的发行版，目前支持<code>fedora,debian,ubuntu,arch,opensuse,mageia,centos,centos_epel,openmandriva,rocky,rocky_epel,alma,alma_epel,gentoo,custom</code>。默认使用主机的发行版。<ul>
<li>当<code>Distribution=custom</code>时，无法自动构建Rootfs，需要自行提供。</li>
</ul>
</li>
<li><code>Release=</code>：使用的版本。默认使用主机的版本。</li>
<li><code>Architecture=</code>：使用的架构。默认使用主机的架构。</li>
<li><code>Mirror=</code>：使用的镜像源。<ul>
<li>在使用EPEL时，如果要为EPEL使用其他镜像，使用<code>$EPEL_MIRROR</code>环境变量。</li>
<li>Debian的Debug和Security源无法直接切换镜像，考虑使用<code>mkosi.pkgmngr</code>，或是构建无Debug和Security仓库的<code>sid|unstable</code>版本。</li>
</ul>
</li>
<li><code>LocalMirror=</code>：在构建时使用的镜像源，但并不写入最终镜像内。</li>
<li><code>RepositoryKeyCheck=</code>：检查镜像源密钥。</li>
<li>（新版本）<code>RepositoryKeyFetch=</code>：在安装时自动尝试获取软件源密钥，默认启用，如果禁用，将从宿主机传递软件源密钥，这需要安装对应的<code>*-keyring</code>软件包。</li>
<li><code>Repositories=</code>：启用的Yum源名（例如<code>epel</code>），或是Apt源的分区（例如<code>main</code>）。使用逗号分隔。</li>
</ul>
<h3 id="Output-段"><a href="#Output-段" class="headerlink" title="[Output]段"></a><code>[Output]</code>段</h3><p>输出方式。</p>
<ul>
<li><code>Format=</code>：导出格式，<code>mkosi</code>支持非常多种镜像，包括但不仅限于：<ul>
<li><code>disk</code>（旧版本为<code>gpt_ext4|gpt_ext4|gpt_xfs</code>）：GPT+UEFI磁盘镜像。使用<code>systemd-repart</code>生成。</li>
<li><code>directory</code>：纯目录形式的容器根文件系统。</li>
<li><code>tar</code>：Tar包。</li>
<li><code>cpio</code>：CPIO包。</li>
<li><code>uki</code>：UKI镜像。</li>
<li><code>esp</code>：类似于<code>uki</code>，但是转换为一个包含单个ESP的GPT分区表的磁盘镜像。</li>
<li><code>oci</code>：OCI容器镜像。</li>
<li><code>sysext|confext|portable</code>：系统扩展镜像。</li>
<li><code>none</code>：当前配置用于分组，不实际生成镜像。</li>
</ul>
</li>
<li><code>ManifestFormat=</code>：生成镜像大纲（保存安装的所有软件包列表）的格式，可选<code>json</code>或<code>changelog</code>，默认不生成。</li>
<li><code>Output=</code>：镜像文件&#x2F;目录的前缀，默认为<code>image</code>。</li>
<li><code>OutputDirectory=</code>：构建产品的保存目录，默认为工作目录下的<code>mkosi.output/</code>。</li>
<li><code>CompressOutput=</code>：输出镜像的压缩方式，请注意，这会导致<code>shell</code>、<code>boot</code>、<code>qemu</code>命令在该镜像上不可用。仅可用于<code>tar</code>、<code>cpio</code>、<code>uki</code>、<code>esp</code>和<code>oci</code>镜像。可选值有布尔值和<code>xz</code>、<code>zstd</code>等压缩算法。默认使用<code>zstd</code>。<ul>
<li><code>CompressLevel=</code>：（新版本）压缩等级。</li>
</ul>
</li>
<li><code>SplitArtifacts=</code>：分开导出的产品列表，使用逗号分隔，可选值有<code>uki</code>、<code>kernel</code>、<code>initrd</code>、<code>partitions</code>。<ul>
<li>默认值<code>no</code>等价于<code>uki,kernel,initrd</code>。</li>
<li><code>uki</code>会导出UKI。</li>
<li><code>kernel</code>和<code>initrd</code>会导出组成UKI的内核和initramfs。</li>
<li><code>partitions</code>在使用磁盘镜像时，会告诉<code>systemd-repart</code>针对每个分区分别进行导出。默认情况下，导出的分区文件会以<code>镜像名.分区名</code>命名。</li>
<li><code>OutputSplitRoot=</code>：（旧版本）导出根分区镜像的名称。</li>
<li><code>OutputSplitVerify=</code>：（旧版本）导出的校验分区的名称。</li>
<li><code>OutputSplitKernel=</code>：（旧版本）导出的ESP分区的名称。</li>
</ul>
</li>
<li><code>ImageVersion=</code>：镜像的版本号。<ul>
<li>你也可以使用<code>mkosi.version</code>指定版本号，此文件还可以是一个可执行的Shell脚本，使其输出作为版本号。</li>
</ul>
</li>
<li><code>ImageID=</code>：镜像名称，会写入镜像的<code>os-release</code>文件中。</li>
<li>（新版本）<code>RepartDirectories=</code>：<code>systemd-repart</code>的分区定义配置文件目录，默认为工作目录下的<code>mkosi.repart/</code>。<ul>
<li>注意，MKOSI的分区配置文件中的<code>CopyFiles=</code>的源路径会使用镜像中的根文件系统。</li>
</ul>
</li>
<li>（新版本）<code>SectorSize=</code>：<code>systemd-repart</code>的块大小。</li>
<li>（新版本）<code>Seed=</code>：<code>systemd-repart</code>使用的UUID，也可以使用<code>mkosi.seed</code>文件保存，默认值为<code>random</code>。</li>
<li>（新版本）<code>Overlay=</code>：和<code>BaseTrees=</code>一起使用，是否仅仅保留相对于Base Tree发生改变的内容，用于构建系统扩展镜像。<ul>
<li>在构建系统扩展镜像时，可以使用该选项结合<code>BaseTree=</code>指定的目录以获取增量部分，即扩展镜像的部分。</li>
</ul>
</li>
<li>（新版本）<code>CleanScripts=</code>：用于构建的最后阶段进行清理的脚本，默认为<code>mkosi.clean</code>。</li>
</ul>
<h3 id="（v20以上版本）-Build-段"><a href="#（v20以上版本）-Build-段" class="headerlink" title="（v20以上版本）[Build]段"></a>（v20以上版本）<code>[Build]</code>段</h3><ul>
<li><code>ToolsTree=</code>：在指定目录下搜索构建工具组，也可以使用<code>mkosi.tools/</code>目录保存，这有助于使用其他版本的构建工具组。<ul>
<li>如果值为<code>default</code>，那么会从指定的发行版的软件源中自动获取Tools Tree。在目标发行版的systemd版本低于构建所需的最低要求时，会自动启用。在当前发行版低于构建所需的最低systemd版本时，该选项必须启用。</li>
<li><code>ToolsTreeDistribution=</code>：用于自动获取<code>ToolsTree=</code>的目标发行版。</li>
<li><code>ToolsTreeRelease=</code>：用于自动获取<code>ToolsTree=</code>的目标发行版版本。</li>
<li><code>ToolsTreeMirror=</code>：用于自动获取<code>ToolsTree=</code>的目标发行版镜像源。</li>
<li><code>ToolsTreeRepositories=</code>：和<code>Repositories=</code>一样，但是用于构建<code>ToolsTree=</code>。</li>
<li><code>ToolsTreeSandboxTrees=</code>：和<code>SandboxTrees=</code>一样，但是用于构建<code>ToolsTree=</code>。</li>
<li><code>ToolsTreePackages=</code>：在<code>ToolsTree=</code>中包含的额外软件包。</li>
<li><code>ToolsTreeCertificates=</code>：是否使用Tools Tree中的证书，这包括<code>/etc/pki</code>、<code>/etc/ssl</code>、<code>/etc/ca-certificates</code>和<code>/var/lib/ca-certificates</code>，如果禁用，使用主机上的证书。</li>
</ul>
</li>
<li><code>Incremental=</code>：渐进构建，可选值为布尔值或<code>strict</code>。在执行<code>mkosi.build</code>脚本之前提供镜像缓存，这可以显著提高构建速度。如果为<code>strict</code>，那么如果缓存镜像不存在则会报错退出。</li>
<li><code>CacheOnly=</code>：纯缓存模式，可选值有<code>auto</code>、<code>metadata</code>、<code>always</code>或<code>never</code>，如果为<code>always</code>，那么包管理器不会联网，只使用本地缓存；如果为<code>metadata</code>，那么包管理器不会联网更新元数据；如果为<code>auto</code>，那么仅在不存在缓存镜像时更新元数据。</li>
<li><code>SandboxTrees=</code>：接受逗号分隔的，冒号绝对路径对。前者是主机上的路径，后者是MKOSI沙箱内的路径，表示在执行构建之前拷贝到沙箱的文件。也可以使用<code>mkosi.sandbox/</code>目录进行保存。</li>
<li><code>WorkspaceDirectory=</code>：临时文件的保存目录，默认为<code>$XDG_CACHE_HOME</code>或<code>$HOME/.cache</code>或<code>/var/tmp</code>。</li>
<li><code>CacheDirectory=</code>：构建时软件包管理器缓存的保存目录，默认使用工作目录下的<code>mkosi.cache/</code>。</li>
<li><code>PackageCacheDirectory=</code>：软件包管理器的缓存目录。</li>
<li><code>BuildDirectory=</code>：用于执行Out-of-Tree构建的构建目录，这使得构建产品可以在多次构建时共享。默认为<code>mkosi.builddir/</code>。</li>
<li><code>UseSubvolumes=</code>：是否使用Btrfs子卷，可选值有布尔值或<code>auto</code>。</li>
<li><code>RepartOffline=</code>：是否在不使用回环设备的情况下构建磁盘镜像，仅在以XFS为根文件系统且启用SELinux的情况下需要启用。</li>
<li><code>History=</code>：是否保存历史，历史会被保存在<code>.mkosi-private</code>目录下。</li>
<li><code>ExtraSearchPaths=</code>：用于搜索工具的额外目录，会在构建时被添加到<code>$PATH</code>中。</li>
<li><code>ProxyUrl=</code>：使用的代理地址。<ul>
<li><code>ProxyExclude=</code>：不使用代理的主机名。</li>
<li><code>ProxyPeerCertificate=</code>：代理Peer的证书。</li>
<li><code>ProxyClientCertificate=</code>：代理客户端的证书。</li>
<li><code>ProxyCientKey=</code>：代理客户端的Key。</li>
</ul>
</li>
</ul>
<h3 id="Content-段"><a href="#Content-段" class="headerlink" title="[Content]段"></a><code>[Content]</code>段</h3><p>镜像配置：</p>
<ul>
<li><code>Packages=</code>：包含的包，使用逗号或是换行符分隔。会使用该发行版对应的包管理器进行安装。</li>
<li><code>BuildPackages=</code>：在构建的Overlayfs中安装包。这样的包应当用于<code>mkosi.build</code>脚本。</li>
<li><code>PackageDirectories=</code>：读取指定目录下的额外软件包并在构建时在镜像中进行安装。</li>
<li>（新版本）<code>WithRecommends=</code>：是否安装弱依赖，仅适用于<code>apt</code>、<code>dnf</code>和<code>zypper</code>。默认禁用。</li>
<li><code>WithDocs=</code>：是否在镜像内保留文档。默认启用。</li>
<li>（新版本）<code>MakeInitrd=</code>：是否在镜像内创建<code>/init</code>和<code>/etc/initrd-release</code>文件。该配置项通常在MKOSI-INITRD内部使用。</li>
<li>（新版本）<code>BaseTrees=</code>：接受逗号分隔的，冒号绝对路径对。前者是主机上的路径，后者是镜像内的路径，表示在获取发行版基本根文件系统之前，将主机文件&#x2F;目录拷贝到镜像内。这也是<code>Overlay=yes</code>参考的基础文件系统。如果没有指定镜像内的路径，那么默认为<code>/</code>。</li>
<li><code>SkeletonTrees=</code>：接受逗号分隔的，冒号绝对路径对。前者是主机上的路径，后者是镜像内的路径，表示在已经构建基本根文件系统，开始安装软件包之前，将主机文件&#x2F;目录拷贝到镜像内。<ul>
<li><code>mkosi.skeleton/</code>目录下的文件总是会被拷贝到相同的目标位置下。</li>
</ul>
</li>
<li><code>ExtraTrees=</code>：接受逗号分隔的，冒号绝对路径对。前者是主机上的路径，后者是镜像内的路径，表示在安装软件包之后，将主机文件&#x2F;目录拷贝到镜像内。<ul>
<li><code>mkosi.extra/</code>目录下的文件总是会被拷贝到相同的目标位置下。</li>
</ul>
</li>
<li><code>RemovePackages=</code>：在构建后删除指定的包。</li>
<li><code>RemoveFiles=</code>：在构建后删除指定的文件，路径使用镜像内的根文件系统。</li>
<li><code>CleanPackageMetadata=</code>：是否在构建后清理镜像内包管理器的缓存。默认为是。</li>
<li><code>Bootable=</code>：镜像是否可引导（是否安装引导程序），可选值除了布尔值还有<code>auto</code>。默认为<code>auto</code>，即尽可能设置。如果设为<code>yes</code>，那么在<code>Bootloader=</code>设置的Bootloader软件包不存在时，构建会失败。<ul>
<li>镜像内必须安装对应架构的内核。</li>
<li>（新版本）<code>Bootloader=</code>：使用的引导程序，可选<code>none</code>、<code>systemd-boot</code>或<code>grub</code>。默认为<code>systemd-boot</code>。<ul>
<li>如果<code>Bootable=no</code>，那么该配置项无意义。</li>
<li>如果使用<code>none</code>，那么和<code>Bootable=no</code>效果一致。</li>
<li>如果使用<code>grub</code>，那么镜像中必须安装对应架构的<code>grub</code>软件包，确保存在<code>/usr/lib/grub</code>或<code>/usr/share/grub2</code>目录。</li>
<li>如果使用<code>systemd-boot</code>，那么镜像中必须安装对应架构的<code>grub</code>软件包，确保存在<code>bootctl</code>程序。</li>
</ul>
</li>
<li>（新版本）<code>BiosBootloader=</code>：是否安装BIOS引导，可选<code>none</code>或<code>grub</code>，如果启用，那么需要创建大小为1MB，类型为<code>21686148-6449-6e6f-744e-656564454649</code>的<code>biosboot</code>分区。默认为<code>none</code>。<ul>
<li>如果<code>Bootable=no</code>，那么该配置项无意义。</li>
<li>如果使用<code>grub</code>，那么镜像中必须安装对应架构的<code>grub</code>软件包。</li>
</ul>
</li>
<li>（新版本）<code>ShimBootLoader=</code>：是否安装Shim，可选<code>none</code>、<code>unsigned</code>或<code>signed</code>。在<code>SecureBoot=true</code>的情况下，如果为<code>unsigned</code>，那么MKOSI会安装未签名的Shim，并自行对其进行签名，如果为<code>signed</code>，那么MKOSI会安装已签名的Shim。默认为<code>none</code>。<ul>
<li>如果设为<code>unsigned</code>，那么镜像内必须安装<code>shim-unsigned</code>软件包。</li>
<li>如果设为<code>signed</code>，那么镜像内必须安装<code>shim-signed</code>软件包。</li>
<li>在没有启用<code>SecureBoot=true</code>的情况下，该选项没有意义。</li>
</ul>
</li>
</ul>
</li>
<li>（新版本）<code>KernelModulesInclude=</code>：在镜像中包含的内核模块，格式为相对于<code>/usr/lib/modules/内核版本/kernel</code>目录的路径正则表达式，这对于initramfs特别有用。<ul>
<li>关键词<code>default</code>表示包含MKOSI-INITRD的<code>mkosi.conf</code>中的所有默认配置，参见<a target="_blank" rel="noopener" href="https://github.com/systemd/mkosi/blob/main/mkosi/resources/mkosi-initrd/mkosi.conf">mkosi.conf</a>。这也是未设置该配置项的默认值。</li>
<li>关键词<code>host</code>表示包含宿主机当前加载的所有模块。</li>
</ul>
</li>
<li>（新版本）<code>KernelModulesExclude=</code>：在镜像中排除的内核模块。<ul>
<li>因为MKOSI默认会加载<code>mkosi-initrd</code>的配置，因此如果希望重设模块，必须先设置<code>KernelModulesExclude=.*</code>。</li>
</ul>
</li>
</ul>
<p>initramfs配置：</p>
<ul>
<li>（新版本）<code>KernelModulesInitrd=</code>：是否在<code>Bootable=true</code>的镜像中使用MKOSI构建一个独立的，额外的initramfs，默认启用。<ul>
<li>这是推荐的行为，因为MKOSI开发组期望构建出的镜像使用与本地环境无关的initramfs。构建过程中会使用镜像内的安装的内核和固件（在安装时均会被MKOSI移动到<code>/usr/lib/modules/</code>目录下）进行打包。</li>
</ul>
</li>
<li>（新版本）<code>KernelModulesInitrdInclude=</code>：在initramfs中包含的模块。<ul>
<li>关键词<code>default</code>表示包含MKOSI-INITRD的<code>mkosi.conf</code>中的所有默认配置，参见<a target="_blank" rel="noopener" href="https://github.com/systemd/mkosi/blob/main/mkosi/resources/mkosi-initrd/mkosi.conf">mkosi.conf</a>。这也是未设置该配置项的默认值。</li>
<li>关键词<code>host</code>表示包含宿主机当前加载的所有模块。</li>
</ul>
</li>
<li>（新版本）<code>KernelModulesInitrdExclude=</code>：在initramfs中排除的模块。</li>
<li><code>UnifiedKernelImages=</code>：是否使用UKI而不是独立initramfs。默认为<code>auto</code>，即尽可能使用。<ul>
<li>如果启用了UKI：如果<code>systemd-repart</code>发现了存在哈希值（即，启用了Verity）的根文件系统分区，那么会将其哈希值写入UKI的<code>roothash=</code>内核命令行参数中。否则，如果<code>systemd-repart</code>发现了存在哈希值（即，启用了Verity）的<code>/usr/</code>文件系统分区，那么会将其哈希值写入UKI的<code>usrhash=</code>内核命令行参数中。</li>
<li>如果未启用UKI，且使用<code>systemd-boot</code>：如果<code>systemd-repart</code>发现了存在哈希值（即，启用了Verity）的根文件系统分区，那么会将其哈希值写入BLS引导条目的<code>roothash=</code>内核命令行参数中。否则，如果<code>systemd-repart</code>发现了存在哈希值（即，启用了Verity）的<code>/usr/</code>文件系统分区，那么会将其哈希值写入BLS引导条目的<code>usrhash=</code>内核命令行参数中。否则，如果找到了GPT PARTLABEL为<code>root*</code>的分区，那么会将其PARTUUID写入BLS引导条目的<code>root=PARTUUID=</code>内核命令行参数中。</li>
<li>如果未启用UKI，且使用GRUB：如果<code>systemd-repart</code>发现了存在哈希值（即，启用了Verity）的根文件系统分区，那么会将其哈希值写入<code>grub.cfg</code>的<code>roothash=</code>内核命令行参数中。否则，如果<code>systemd-repart</code>发现了存在哈希值（即，启用了Verity）的<code>/usr/</code>文件系统分区，那么会将其哈希值写入<code>grub.cfg</code>的<code>usrhash=</code>内核命令行参数中。否则，如果找到了GPT PARTLABEL为<code>root*</code>的分区，那么会将其PARTUUID写入<code>grub.cfg</code>的<code>root=PARTUUID=</code>内核命令行参数中。否则，如果找到了GPT PARTLABEL为<code>usr*</code>的分区，那么会将其PARTUUID写入<code>grub.cfg</code>的<code>mount.usr=PARTUUID=</code>内核命令行参数中。</li>
<li><code>UnifiedKernelImageFormat=</code>：UKI文件命名，默认为<code>&amp;e-&amp;k</code>，支持的占位符有：<ul>
<li><code>&amp;&amp;</code>：<code>&amp;</code>本身。</li>
<li><code>&amp;e</code>：Token。</li>
<li><code>&amp;k</code>：内核版本。</li>
<li><code>&amp;h</code>：<code>roothash=</code>或<code>usrhash=</code>的值。</li>
<li><code>&amp;c</code>：引导尝试次数。</li>
</ul>
</li>
<li><code>UnifiedKernelImageProfiles=</code>：构建额外的UKI配置，接受逗号分隔的UKI配置文件。也可以保存在<code>mkosi.uki-profiles/</code>目录下。UKI配置以<code>.conf</code>结尾，只有一个<code>UKIProfile</code>段，可用内容有：<ul>
<li><code>Profile=</code>：配置信息，包括<code>ID</code>（必须）和<code>TITLE</code>。</li>
<li><code>Cmdline=</code>：内核命令行参数。</li>
</ul>
</li>
<li><code>PeAddons=</code>：（<strong>已被移除</strong>）构建额外的PE插件，接收逗号分隔的<code>ukify</code>配置文件，额外的PE插件会以<code>配置文件名.addon.efi</code>命名，也可以将<code>ukify</code>配置文件保存在<code>mkosi.pe-addons/</code>目录下。</li>
</ul>
</li>
<li>（新版本）<code>MicrocodeHost=</code>：是否在initramfs中仅仅包含主机的CPU微码。默认禁用。</li>
<li>（新版本）<code>InitrdPackages=</code>：在initramfs中额外安装的软件包。</li>
<li>（新版本）<code>Initrds=</code>：使用用户提供的指定initramfs，而不是自行构建。</li>
<li><code>KernelCommandLine=</code>：封装在UKI或initramfs内的内核命令行参数。<ul>
<li>如果检测到使用了Verity的<code>root</code>分区或<code>usr</code>分区，那么会自动填充<code>roothash=分区Hash值</code>或<code>usrhash=分区Hash值</code>。</li>
<li>内核命令行参数<code>root=PARTUUID</code>和<code>mount.usr=PARTUUID</code>会被自动填充类型为<code>root</code>或<code>/usr</code>的分区的UUID。</li>
</ul>
</li>
</ul>
<p>镜像预设配置：</p>
<ul>
<li><code>MachineID=</code>：设置镜像内的机器ID，默认为<code>random</code>，也可以使用<code>mkosi.machine-id</code>文件保存。</li>
<li><code>Locale=</code>：镜像内的语言。</li>
<li><code>Keymap=</code>：镜像内的Keymap。</li>
<li><code>Hostname=</code>：设置镜像内的默认主机名。</li>
<li><code>RootShell=</code>：Root用户的默认Shell。</li>
<li><code>RootPassword=</code>（旧版本为<code>Password=</code>）：设置镜像内Root用户的默认密码。<ul>
<li>也可以在工作目录下编写<code>mkosi.rootpw</code>文件。</li>
</ul>
</li>
<li><code>Autologin=</code>：是否设置Root用户在<code>/dev/pts/0</code>、<code>/dev/tty1</code>和<code>/dev/hvc0</code>的自动登录。</li>
<li><code>Ssh=</code>：是否在镜像内创建SSH套接字以允许通过<code>mkosi ssh</code>连接，使用<code>mkosi genkey</code>创建密钥。</li>
<li><code>SELinuxRelabel=</code>：是否在镜像内进行Relabel。</li>
</ul>
<p>为了实现更多功能，还可以在构建镜像的不同过程中执行脚本：</p>
<ul>
<li>（新版本）<code>SyncScripts=</code>：在同步软件包管理器元数据后执行的脚本，默认为<code>mkosi.sync</code>。</li>
<li><code>PrepareScripts=</code>：在安装软件包后立刻执行的脚本。默认为<code>mkosi.prepare</code>。</li>
<li><code>BuildScripts=</code>：在创建好根文件系统后立刻执行的脚本。默认为<code>mkosi.build</code>。<ul>
<li><code>BuildSources=</code>：接受逗号分隔的，冒号绝对路径对。前者是主机上的路径，后者是镜像内的路径，进行构建时拷贝的代码树目录，镜像内的代码树目录总是会自动添加<code>/work/src</code>前缀。</li>
<li><code>BuildSourcesEphemeral=</code>：是否不保留对源码树的更改，默认禁用。</li>
</ul>
</li>
<li><code>PostInstallationScripts=</code>：在配置完Extra Tree后执行的脚本，默认为<code>mkosi.postinst</code>。</li>
<li><code>FinalizeScripts=</code>：在构建完全完成后的最后阶段执行的脚本，默认为<code>mkosi.finalize</code>。</li>
<li><code>PostOutputScripts=</code>：在输出产品后执行的脚本，默认为<code>mkosi.postoutput</code>。</li>
<li><code>Environment=</code>：给脚本传递的环境变量。</li>
<li><code>EnvironmentFile=</code>：从文件给脚本传递环境变量。</li>
<li><code>WithTests=</code>：设为假，则在执行<code>mkosi.build</code>脚本时，<code>$WITH_TESTS</code>变量为0。</li>
<li><code>WithNetwork=</code>：在执行脚本时提供网络。</li>
</ul>
<h3 id="Validation-段"><a href="#Validation-段" class="headerlink" title="[Validation]段"></a><code>[Validation]</code>段</h3><ul>
<li><code>SecureBoot=</code>：是否启用安全启动，这会影响是否对UKI进行签名。</li>
<li><code>SecureBootAutoEnroll=</code>：是否自动导入安全启动的Key。<ul>
<li>这仅对虚拟机生效，如果希望对物理机生效，在Extra Tree中包含<code>/efi/loader/loader.conf</code>文件，并写入<code>secure-boot-enroll force</code>或<code>secure-boot-enroll manual</code>。</li>
</ul>
</li>
<li><code>SecureBootKey=</code>：使用的安全启动PEM密钥。默认使用<code>mkosi.key</code>。</li>
<li><code>SecureBootCertificate=</code>：使用的安全启动X509证书。默认使用<code>mkosi.crt</code>。</li>
<li><code>SecureBootSignTool=</code>：为PE文件进行安全启动签名的程序，可选<code>systemd-sbsign</code>、<code>sbsign</code>、<code>pesign</code>或<code>auto</code>。</li>
<li><code>SignExpectedPcr=</code>：使用<code>systemd-measure</code>在UKI中包含PCR（平台配置寄存器）的签名，可选布尔值或<code>auto</code>。</li>
<li><code>Passphrase=</code>：LUKS加密的密钥文件，必须是600权限位，它应当保存完整的LUKS密钥，以一个换行结尾（即<code>/etc/crypttab</code>文件的格式）。<ul>
<li>也可以选择在工作目录下创建<code>mkosi.passphrase</code>文件。</li>
</ul>
</li>
<li><code>VerityKey=</code>：用于为Verity设备签名的PEM密钥。默认使用<code>mkosi.key</code>。</li>
<li><code>VerityCertificate=</code>：用于为Verity设备签名的X509证书。默认使用<code>mkosi.crt</code>。</li>
<li><code>Checksum=</code>：指定镜像的校验码。</li>
<li><code>Sign=</code>：是否用<code>gpg</code>给校验码签名。默认为否。</li>
<li><code>Key=</code>：给校验码签名的密钥。</li>
<li><code>OpenPGPTool=</code>：使用的OpenPGP实现，默认为<code>gpg</code>，可选值有<code>sqop</code>、<code>rsop</code>。</li>
</ul>
<h3 id="Runtime-段（旧版本为-Host-段）"><a href="#Runtime-段（旧版本为-Host-段）" class="headerlink" title="[Runtime]段（旧版本为[Host]段）"></a><code>[Runtime]</code>段（旧版本为<code>[Host]</code>段）</h3><ul>
<li><code>Credentials=</code>：启动时传递给镜像中的systemd的系统凭据。</li>
</ul>
<p>容器配置：</p>
<ul>
<li><code>NSpawnSettings=</code>：使用<code>systemd-nspawn</code>启动时，读取的<code>.nspawn</code>单元文件。<ul>
<li>默认使用<code>mkosi.nspawn</code>文件。</li>
</ul>
</li>
</ul>
<p>所有虚拟机配置项都仅适用于使用<code>qemu</code>启动的虚拟机，即只适用于磁盘类型的镜像：</p>
<ul>
<li><code>VirtualMachineMonitor=</code>：使用的虚拟机超管，可选值有<code>qemu</code>或<code>vmspawn</code>。</li>
<li><code>QemuGui=</code>：若启用，会以图形界面形式启动Qemu。默认以Headless形式启动。<ul>
<li>旧版本下为<code>QemuHeadless=</code>：若启用，会以Headless形式启动Qemu。默认以图形界面形式启动。</li>
</ul>
</li>
<li><code>QemuSmp=</code>：设置Qemu的SMP。默认为2。</li>
<li><code>QemuMem=</code>：设置Qemu的内存。默认为2G。</li>
<li><code>QemuKvm=</code>：是否启用KVM加速，默认为<code>auto</code>。</li>
<li><code>QemuVsock=</code>：是否启用VSock，默认为<code>auto</code>。</li>
<li><code>QemuVsockConnectionId=</code>：VSock的连接ID，可选值有<code>hash</code>、<code>auto</code>或手动输入。</li>
<li><code>QemuSwtpm=</code>：是否启用TPM，默认为<code>auto</code>。</li>
<li><code>QemuCdrom=</code>：是否在Qemu中以CD形式读取镜像，默认禁用。</li>
<li><code>QemuBoot=</code>：使用的Qemu固件，可选<code>uefi</code>、<code>linux</code>。<ul>
<li>新版本下改为<code>QemuFirmware=</code>：可选<code>uefi</code>、<code>bios</code>、<code>linux</code>、<code>auto</code>。</li>
<li>新版本下可以使用<code>QemuFirmwareVariables=</code>设置UEFI固件中的变量。</li>
<li>新版本下可用<code>QemuKernel=</code>，指定使用的Direct Boot Kernel。</li>
</ul>
</li>
<li><code>QemuDrives=</code>：添加的驱动器，格式为<code>ID:大小[:目录:选项]</code>。</li>
<li><code>RuntimeTrees=</code>接受逗号分隔的，冒号绝对路径对。前者是主机上的路径，后者是虚拟机内的路径，如果没有后面的部分，则自动挂载在<code>/root/src</code>目录下。</li>
<li><code>RuntimeSize=</code>：将镜像在启动时扩大到指定大小。</li>
<li><code>RuntimeNetwork=</code>：使用的Qemu网络，可选值有<code>user</code>、<code>interface</code>或<code>none</code>。</li>
<li><code>RuntimeBuildSources=</code>：挂载指定的源代码目录到虚拟机内的<code>/work</code>目录下。</li>
<li><code>RuntimeHome=</code>：是否挂载主机的家目录到虚拟机的<code>/root</code>。</li>
<li><code>RuntimeScratch=</code>：是否在<code>/var/tmp</code>下挂载额外的空间。可选值为布尔值或<code>auto</code>。</li>
<li><code>UnitProperties=</code>：传递给NSPawn的Scope属性。</li>
<li><code>KernelCommandLineExtra=</code>：通过Qemu传递的额外内核命令行参数。<ul>
<li>在Qemu中硬编码的额外内核命令行参数为（<a target="_blank" rel="noopener" href="https://github.com/systemd/mkosi/blob/main/mkosi/qemu.py">mkosi&#x2F;mkosi&#x2F;qemu.py</a>）：<ul>
<li><code>rw</code></li>
<li><code>systemd.wants=network.target</code></li>
<li><code>module_blacklist=vmw_vmci systemd.tty.term.hvc0=宿主机终端类型 systemd.tty.columns.hvc0=宿主机终端列数 systemd.tty.rows.hvc0=宿主机终端行数</code></li>
</ul>
</li>
<li>除非明确地手动进行设置，否则存在以下内核命令行参数的默认值：<ul>
<li><code>ip=enc0:any ip=enp0s1:any ip=enp0s2:any ip=host0:any ip=none</code></li>
<li><code>loglevel=4</code></li>
<li><code>SYSTEMD_SULOGIN_FORCE=1</code></li>
</ul>
</li>
</ul>
</li>
<li><code>QemuArgs</code>：配置空格分隔的Qemu原生参数。</li>
<li><code>Ephemeral=</code>：是否将镜像设为不可变，所有操作在关闭之后都会撤销。</li>
<li><code>SshKey=</code>：使用的SSH私钥。</li>
<li><code>SshCertificate=</code>：使用的SSH证书。</li>
<li><code>Machine=</code>：机器名，用于SSH连接。</li>
<li><code>ForwardJournal=</code>：是否将容器或虚拟机的日志发送到宿主机。</li>
<li><code>SysupdateDirectory=</code>：<code>mkosi sysupdate</code>使用的配置目录，默认使用<code>mkosi.sysupdate/</code>。<ul>
<li>MKOSI使用的Sysupdate配置必须设置<code>PathRelativeTo=explicit</code>和<code>Path=/</code>才能正常使用<code>sysupdate</code>子命令进行更新，这会使得配置中的<code>Path=</code>使用<code>mkosi.output/</code>（或<code>OutputDirectory=</code>指定的目录）作为根。</li>
<li>这同时也意味着，<code>SplitArtifacts=</code>必须启用以对分区进行更新，而且更新内容（分区镜像文件、EFI程序、initramfs）文件名必须与Sysupdate配置中的<code>MatchPattern=</code>匹配。</li>
</ul>
</li>
</ul>
<h3 id="分区"><a href="#分区" class="headerlink" title="分区"></a>分区</h3><p>（旧版本，现已删除）在<code>[Partitions]</code>段内支持以下配置项：</p>
<ul>
<li><code>RootSize=</code>：根分区大小，默认为3G。</li>
<li><code>ESPSize=</code>：ESP大小，默认为256MB。仅在<code>Bootable=yes</code>时有效。</li>
<li><code>SwapSize=</code>：Swap分区大小，默认为0。</li>
<li><code>HomeSize=</code>：<code>/home</code>分区大小，默认为0。</li>
<li><code>SrvSize=</code>：<code>/srv</code>分区大小，默认为0。</li>
<li><code>VarSize=</code>：<code>/var</code>分区大小。默认为0。</li>
<li><code>TmpSize=</code>：<code>/var/tmp</code>分区大小。默认为0。</li>
<li><code>BiosSize=</code>：<code>biosboot</code>分区大小，默认为0。</li>
<li><code>XbootldrSize=</code>：<code>XBOOTLDR</code>分区大小。默认为0。</li>
<li><code>UsrOnly=</code>：仅仅保留<code>/usr</code>目录，很适合无状态的镜像。</li>
</ul>
<p>MKOSI会从<code>mkosi.repart/</code>或<code>RepartDirectories=</code>指定的目录中读取<code>systemd-repart</code>的配置文件，并据此对磁盘镜像进行分区。文件命名应当为<code>优先级-分区名.conf</code>，格式为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[Partition]</span><br><span class="line">Type=分区类型</span><br><span class="line">Format=文件系统</span><br><span class="line"># 是否精简化文件系统</span><br><span class="line">Minimize=best|off|guess</span><br><span class="line">SizeMinBytes=最小大小</span><br><span class="line">SizeMaxBytes=最大大小</span><br></pre></td></tr></table></figure>

<p>默认情况下，MKOSI使用以下内置配置：</p>
<p><code>00-esp.conf</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[Partition]</span><br><span class="line">Type=esp</span><br><span class="line">Format=vfat</span><br><span class="line">CopyFiles=/boot:/</span><br><span class="line">CopyFiles=/efi:/</span><br><span class="line">SizeMinBytes=512M</span><br><span class="line">SizeMaxBytes=512M</span><br></pre></td></tr></table></figure>
<ul>
<li>需要注意的是，<code>CopyFiles=</code>的源路径的根是构建中的镜像的根。</li>
</ul>
<p><code>05-bios.conf</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[Partition]</span><br><span class="line"># UUID of the grub BIOS boot partition which grubs needs on GPT to</span><br><span class="line"># embed itself into.</span><br><span class="line">Type=21686148-6449-6e6f-744e-656564454649</span><br><span class="line">SizeMinBytes=1M</span><br><span class="line">SizeMaxBytes=1M</span><br></pre></td></tr></table></figure>
<p><code>10-root.conf</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[Partition]</span><br><span class="line">Type=root</span><br><span class="line">Format=&lt;distribution-default-filesystem&gt;</span><br><span class="line">CopyFiles=/</span><br><span class="line">Minimize=guess</span><br></pre></td></tr></table></figure>

<h2 id="资源目录"><a href="#资源目录" class="headerlink" title="资源目录"></a>资源目录</h2><p>有以下相关的资源目录：</p>
<ul>
<li><code>mkosi.conf.d/</code>：额外的MKOSI配置，可以是文件，也可以是子工作目录，子工作目录支持的内容和MKOSI的主工作目录完全一致（必须包含<code>mkosi.conf</code>文件）。<ul>
<li>如果使用文件的话，那么文件中的<code>[Match]</code>段仅对该文件生效。</li>
<li>如果使用子工作目录的话，那么子工作目录中的<code>mkosi.conf</code>中的<code>[Match]</code>段对整个子工作目录生效。</li>
</ul>
</li>
<li><code>mkosi.local/</code>：额外的本地MKOSI配置，可以是文件，也可以是子工作目录。</li>
<li><code>mkosi.skeleton/</code>或<code>mkosi.skeleton.tar</code>：在已经构建基本根文件系统，开始安装软件包之前，将文件&#x2F;目录拷贝到镜像内。与<code>SkeletonTrees=</code>配置项有关。</li>
<li><code>mkosi.extra/</code>或<code>mkosi.extra.tar</code>：在安装软件包之后，将额外的文件&#x2F;目录拷贝到镜像内。与<code>ExtraTrees=</code>配置项有关。</li>
<li><code>mkosi.pkgmngr/</code>或<code>mkosi.pkgmngr.tar</code>：在构建时配置包管理器，但是不将文件写入镜像。这可以作为在构建时手动配置软件包管理器的手段，如果需要包含到镜像中，应该使用<code>mkosi.skeleton/</code>或<code>mkosi.skeleton.tar</code>。</li>
<li><code>mkosi.nspawn</code>：<code>systemd-nspawn</code>读取的容器单元文件。与<code>NspawnSettings=</code>配置项有关。</li>
<li><code>mkosi.cache/</code>：构建时软件包管理器缓存的保存目录。与<code>CacheDirectory=</code>配置项有关。</li>
<li><code>mkosi.builddir/</code>：用于执行Out-of-Tree构建的构建目录。与<code>BuildDirectory=</code>配置项有关。</li>
<li><code>mkosi.rootpw</code>：镜像中Root用户的密码。文件必须具有0600或更低的权限位。与<code>RootPasswordFile=</code>配置项有关。</li>
<li><code>mkosi.passphrase</code>：LUKS加密使用的密码。文件必须具有0600或更低的权限位。与<code>PassphraseFile=</code>配置项有关。</li>
<li><code>mkosi.crt</code>和<code>mkosi.key</code>：用于签名（UEFI SecureBoot、Verity等）的X.509证书和PEM私钥。与<code>SecureBootCertificate=</code>、<code>SecureBootKey=</code>、<code>VerityCertificate=</code>和<code>VerityKey=</code>配置项有关。</li>
<li><code>mkosi.output/</code>：用于保存所有的构建产品。与<code>OutputDirectory=</code>配置项有关。</li>
<li><code>mkosi.credentials/</code>：额外的系统凭据。目录中的每个文件名将用作凭据名，文件内容成为凭据值。与<code>Credentials=</code>配置项有关。</li>
<li><code>mkosi.repart/</code>：用于<code>systemd-repart</code>的分区定义文件，这些文件在构建磁盘镜像时传递给<code>systemd-repart</code>。如果存在<code>mkosi.repart/</code>或是使用了<code>RepartDirectories=</code>，那么就不会使用任何默认的分区定义。与<code>RepartDirectories=</code>配置项有关。</li>
<li><code>mkosi.uki-profiles/</code>：额外的UKI配置文件。与<code>UnifiedKernelImageProfiles=</code>配置项有关。</li>
<li><code>mkosi.pe-addons/</code>：额外的PE插件的<code>ukify</code>配置文件。与<code>PeAddons=</code>配置项有关。</li>
</ul>
<h2 id="钩子脚本"><a href="#钩子脚本" class="headerlink" title="钩子脚本"></a>钩子脚本</h2><p>钩子脚本如果在末尾添加了<code>.chroot</code>后缀（例如，<code>mkosi.postinst.chroot</code>），那么会Chroot到镜像内部执行，否则会在工作环境中执行，脚本中有以下可用变量：</p>
<table>
<thead>
<tr>
<th>Variable</th>
<th>含义</th>
<th><code>configure</code></th>
<th><code>sync</code></th>
<th><code>prepare</code></th>
<th><code>build</code></th>
<th><code>postinst</code></th>
<th><code>finalize</code></th>
<th><code>postoutput</code></th>
<th><code>clean</code></th>
</tr>
</thead>
<tbody><tr>
<td><code>$ARCHITECTURE</code></td>
<td>镜像的架构</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
</tr>
<tr>
<td><code>$QEMU_ARCHITECTURE</code></td>
<td>Qemu格式的架构，用于通过<code>qemu-system-$QEMU_ARCHITECTURE</code>获取Qemu程序</td>
<td>✓</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>$DISTRIBUTION</code></td>
<td>镜像的发行版</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
</tr>
<tr>
<td><code>$DISTRIBUTION_ARCHITECTURE</code></td>
<td>发行版格式的架构</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
</tr>
<tr>
<td><code>$RELEASE</code></td>
<td>镜像的版本</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
</tr>
<tr>
<td><code>$PROFILES</code></td>
<td><code>Profiles=</code>中设置的配置文件，使用逗号分隔</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
<td></td>
<td>✓</td>
</tr>
<tr>
<td><code>$CACHED</code></td>
<td>如果有可用的缓存，为<code>1</code></td>
<td></td>
<td>✓</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>$CHROOT_SCRIPT</code></td>
<td>Chroot的目标路径，用于结合<code>mkosi-chroot</code>使用</td>
<td></td>
<td></td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>$SRCDIR</code></td>
<td>执行Chroot前的路径</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
</tr>
<tr>
<td><code>$CHROOT_SRCDIR</code></td>
<td>执行Chroot以后，原来的目录所在的路径</td>
<td></td>
<td></td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>$BUILDROOT</code></td>
<td>当前正在构建的镜像的根目录</td>
<td></td>
<td></td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>$BUILDDIR</code></td>
<td>树外构建目录的路径</td>
<td></td>
<td></td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>$CHROOT_BUILDDIR</code></td>
<td>Chroot以后，树外构建目录的路径</td>
<td></td>
<td></td>
<td></td>
<td>✓</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>$DESTDIR</code></td>
<td>构建脚本生成产品的保存目录</td>
<td></td>
<td></td>
<td></td>
<td>✓</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>$CHROOT_DESTDIR</code></td>
<td>Chroot以后，构建脚本生成产品的保存目录</td>
<td></td>
<td></td>
<td></td>
<td>✓</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>$OUTPUTDIR</code></td>
<td>构建产品的暂存目录</td>
<td></td>
<td></td>
<td></td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
</tr>
<tr>
<td><code>$CHROOT_OUTPUTDIR</code></td>
<td>Chroot以后，构建产品的暂存目录</td>
<td></td>
<td></td>
<td></td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>$PACKAGEDIR</code></td>
<td>本地包存储的目录</td>
<td></td>
<td></td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>$ARTIFACTDIR</code></td>
<td>构建产品的目录</td>
<td></td>
<td></td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>$WITH_DOCS</code></td>
<td>是否有文档</td>
<td></td>
<td></td>
<td>✓</td>
<td>✓</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>$WITH_TESTS</code></td>
<td>是否有测试</td>
<td></td>
<td></td>
<td>✓</td>
<td>✓</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>$WITH_NETWORK</code></td>
<td>是否有网络</td>
<td></td>
<td></td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>$SOURCE_DATE_EPOCH</code></td>
<td>如果设置了<code>SourceDateEpoch=TIMESTAMP</code>，那么会保存时间戳</td>
<td></td>
<td></td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
<td></td>
<td>✓</td>
</tr>
<tr>
<td><code>$MKOSI_UID</code></td>
<td>调用<code>mkosi</code>的用户UID</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
</tr>
<tr>
<td><code>$MKOSI_GID</code></td>
<td>调用<code>mkosi</code>的用户GID</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
</tr>
<tr>
<td><code>$MKOSI_CONFIG</code></td>
<td>当前镜像配置的JSON</td>
<td></td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
</tr>
<tr>
<td><code>$IMAGE_ID</code></td>
<td><code>ImageID=</code>的值</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
</tr>
<tr>
<td><code>$IMAGE_VERSION</code></td>
<td><code>ImageVersion=</code>的值</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
</tr>
</tbody></table>
<p>此外，以下命令可用：</p>
<ul>
<li><code>mkosi-chroot</code>：一个封装的<code>chroot</code>，会自动Chroot到镜像内执行命令。</li>
<li>镜像的包管理器可用，你也可以使用<code>mkosi-install|remove|upgrade|reinstall</code>封装工具。</li>
<li><code>git</code>已经自动配置好<code>safe.directory=*</code>。</li>
<li><code>useradd</code>和<code>groupadd</code>已经自动配置好<code>--root=$BUILDROOT</code>。</li>
</ul>
<h2 id="执行流程"><a href="#执行流程" class="headerlink" title="执行流程"></a>执行流程</h2><p>创建MKOSI沙箱：</p>
<ol>
<li>解析命令行选项。</li>
<li>解析配置文件。</li>
<li>执行<code>mkosi.configure</code>脚本。</li>
<li>检查当前用户是不是Root，如果当前用户不是Root，则尝试根据当前用户的SubUID和SubGID隔离用户命名空间。</li>
<li>隔离挂载命名空间。</li>
<li>只读化重新挂载各种目录，包括：<ul>
<li><code>/usr</code></li>
<li><code>/etc</code></li>
<li><code>/opt</code></li>
<li><code>/srv</code></li>
<li><code>/boot</code></li>
<li><code>/efi</code></li>
<li><code>/media</code></li>
<li><code>/mnt</code></li>
</ul>
</li>
</ol>
<p>开始构建镜像：</p>
<ol>
<li>（新版本）拷贝Sandbox Tree（<code>mkosi.sandbox/</code>）中的文件到镜像中。</li>
<li>更新软件包元数据。</li>
<li>执行Sync脚本（<code>mkosi.sync</code>），</li>
<li>拷贝Base Tree（<code>mkosi.base/</code>）中的文件到镜像中。</li>
<li>检查并尝试复用缓存镜像。</li>
<li>拷贝一份包管理器元数据到镜像内。</li>
<li>拷贝Skeleton Tree（<code>mkosi.skeleton/</code>）中的文件到镜像中。</li>
<li>安装发行版及其软件包。</li>
<li>使用<code>final</code>参数执行<code>mkosi.prepare</code>脚本。</li>
<li>如果存在<code>mkosi.build</code>脚本的话，在Overlayfs中安装构建所需的软件包。</li>
<li>使用<code>build</code>参数执行<code>mkosi.prepare</code>脚本。</li>
<li>如果存在对应的配置的话，缓存该镜像。</li>
<li>执行<code>mkosi.build</code>脚本。</li>
<li>结束构建。</li>
<li>拷贝构建脚本的产物到镜像内。</li>
<li>拷贝Extra Tree（<code>mkosi.extra/</code>）中的文件到镜像中。</li>
<li>执行<code>mkosi.postinst</code>脚本。</li>
<li>写入配置项中配置的其他杂项文件。例如<code>Ssh=</code>、<code>Autologin=</code>和<code>MakeInitrd=</code>。</li>
<li>安装<code>systemd-boot</code>，并按需配置安全启动。</li>
<li>执行<code>systemd-sysusers</code>。</li>
<li>执行<code>systemd-tmpfiles</code>。</li>
<li>执行<code>systemctl preset-all</code>。</li>
<li>执行<code>depmod</code>。</li>
<li>执行<code>systemd-firstboot</code>。</li>
<li>执行<code>systemd-hwdb</code>。</li>
<li>移除指定的软件包和文件。</li>
<li>按需执行SELinux Relabel。</li>
<li>执行<code>mkosi.finalize</code>脚本。</li>
<li>如果存在对应的配置的话，生成UKI镜像。</li>
<li>导出产物。</li>
<li>执行<code>mkosi.postoutput</code>脚本。</li>
</ol>
<h2 id="最佳实践"><a href="#最佳实践" class="headerlink" title="最佳实践"></a>最佳实践</h2><ol>
<li>创建工作目录，并使用<code>mkosi.conf</code>和<code>mkosi.conf.d/*.conf</code>（或<code>mkosi.conf.d/*/mkosi.conf</code>）配置文件以固化构建信息。</li>
<li>使用<code>mkosi.postinst.chroot</code>脚本在镜像中进行配置。</li>
<li>使用<code>mkosi.extra</code>向镜像中传递额外文件。</li>
<li>使用<code>mkosi.build.chroot</code>基本进行流水线构建。在脚本中使用<code>$BUILDDIR</code>和<code>$SRCDIR</code>获取目录。</li>
<li>缓存有两种方式：使用<code>mkosi.cache</code>目录进行包缓存，或是使用<code>Incremental=</code>进行渐进构建。需要重建渐进缓存时，使用<code>-ff</code>选项。</li>
<li>要测试不同的内核命令行参数的效果，使用<code>KernelCommandLineExtra=</code>而不是重建镜像，以提高效率。</li>
<li>可以在无特权的情况下构建磁盘镜像，但是容器文件系统仍然需要Root权限。</li>
<li>在启用<code>SecureBoot=yes</code>时，可以执行<code>mkosi genkey</code>直接生成证书和密钥，也可以自己创建<code>mkosi.key</code>和<code>mkosi.crt</code>。你还可以使用<code>ShimBootloader=yes</code>以安装Shim。</li>
<li>使用<code>BiosBootloader=grub</code>以为BIOS引导安装GRUB。</li>
<li>使用<code>useradd -m -g $USER --password &quot;$(openssl passwd -stdin -6 &lt;&lt;&lt; &#39;密码明文&#39;)&quot;</code>添加一个普通用户。</li>
<li>在Debian中<code>mkosi qemu</code>不可用，解决方案为执行<code>cp /usr/lib/tmpfiles.d/static-nodes-permissions.conf /etc/tmpfiles.d/static-nodes-permissions.conf</code>，修改<code>/dev/kvm</code>的权限位为<code>0666</code>。</li>
<li>在非特权模式构建时，<code>chown()</code>调用是被禁用的（钩子脚本中没有禁用，要禁用，设置环境变量<code>MKOSI_CHROOT_SUPPRESS_CHOWN=1</code>），要解决该问题，使用SubUID：<code>unshare --map-auto --map-current-user --setuid 0 --setgid 0</code>。</li>
<li>在你正式构建时，使用<code>WithRecommends=no</code>以安装弱依赖。</li>
<li>在使用<code>dd</code>克隆产品镜像前，执行<code>truncate -s|--size=文件大小 镜像文件.img</code>以调整磁盘镜像大小。</li>
<li>MKOSI可以负责构建initramfs，因此一个没有initramfs构建工具的镜像是可能的。<ul>
<li>不过需要注意的是，MKOSI构建的initramfs中会使用systemd作为<code>/init</code>，这与使用MKOSI-INITRD构建的initramfs是一致的。</li>
</ul>
</li>
<li>使用<code>mkosi.profiles/</code>保存不同的镜像口味，使用<code>mkosi.conf.d/</code>保存不同情况下的镜像配置，对于多种子场景的情况，将情况相对少且固定的子场景放在父目录（例如，输出格式为容器或VM），将情况相对较多且不固定的子场景放在子目录（例如，版本）。</li>
<li>使用<code>Format=uki</code>和<code>MakeInitrd=no</code>来创建一个USI（Unified System Image，单个UEFI PE形式的完整系统）。</li>
</ol>
<h2 id="发行版最小化构建"><a href="#发行版最小化构建" class="headerlink" title="发行版最小化构建"></a>发行版最小化构建</h2><p>一些发行版的最小化构建软件包如下：</p>
<h3 id="Arch"><a href="#Arch" class="headerlink" title="Arch"></a>Arch</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[Content]</span><br><span class="line">Packages=linux</span><br><span class="line">         systemd</span><br></pre></td></tr></table></figure>

<h3 id="Fedora"><a href="#Fedora" class="headerlink" title="Fedora"></a>Fedora</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[Content]</span><br><span class="line">Packages=kernel</span><br><span class="line">         systemd</span><br><span class="line">         systemd-boot</span><br><span class="line">         udev</span><br><span class="line">         util-linux</span><br></pre></td></tr></table></figure>

<h3 id="CentOS-Rocky"><a href="#CentOS-Rocky" class="headerlink" title="CentOS&#x2F;Rocky"></a>CentOS&#x2F;Rocky</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[Content]</span><br><span class="line">Packages=kernel</span><br><span class="line">         systemd</span><br><span class="line">         systemd-boot</span><br><span class="line">         udev</span><br></pre></td></tr></table></figure>

<h3 id="Debian"><a href="#Debian" class="headerlink" title="Debian"></a>Debian</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[Content]</span><br><span class="line">Packages=linux-image-generic</span><br><span class="line">         systemd</span><br><span class="line">         systemd-boot</span><br><span class="line">         systemd-sysv</span><br><span class="line">         udev</span><br><span class="line">         dbus</span><br></pre></td></tr></table></figure>

<h3 id="Ubuntu"><a href="#Ubuntu" class="headerlink" title="Ubuntu"></a>Ubuntu</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[Distribution]</span><br><span class="line">Repositories=main,universe</span><br><span class="line"></span><br><span class="line">[Content]</span><br><span class="line">Packages=linux-image-generic</span><br><span class="line">         systemd</span><br><span class="line">         systemd-sysv</span><br><span class="line">         udev</span><br><span class="line">         dbus</span><br></pre></td></tr></table></figure>

<h3 id="OpenSUSE"><a href="#OpenSUSE" class="headerlink" title="OpenSUSE"></a>OpenSUSE</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[Content]</span><br><span class="line">Packages=kernel-default</span><br><span class="line">         systemd</span><br><span class="line">         udev</span><br></pre></td></tr></table></figure>

<h2 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h2><h3 id="构建一个Fedora容器镜像"><a href="#构建一个Fedora容器镜像" class="headerlink" title="构建一个Fedora容器镜像"></a>构建一个Fedora容器镜像</h3><p>使用命令行：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkosi -d fedora -p kernel,systemd,systemd-udev,systemd-boot --format directory build</span><br></pre></td></tr></table></figure>
<p>使用配置文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># mkosi.conf</span><br><span class="line">[Distribution]</span><br><span class="line">Distribution=fedora</span><br><span class="line"></span><br><span class="line">[Output]</span><br><span class="line">Format=directory</span><br><span class="line"></span><br><span class="line">[Content]</span><br><span class="line">Packages=kernel,systemd,systemd-udev,systemd-boot</span><br></pre></td></tr></table></figure>
<p>然后执行：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkosi build</span><br></pre></td></tr></table></figure>

<h3 id="构建一个Debian可引导磁盘镜像"><a href="#构建一个Debian可引导磁盘镜像" class="headerlink" title="构建一个Debian可引导磁盘镜像"></a>构建一个Debian可引导磁盘镜像</h3><p>使用配置文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"># mkosi.conf</span><br><span class="line">[Distribution]</span><br><span class="line">Distribution=debian</span><br><span class="line">Mirror=https://mirrors.tuna.tsinghua.edu.cn/debian</span><br><span class="line">RepositoryKeyCheck=no</span><br><span class="line"></span><br><span class="line">[Output]</span><br><span class="line">Format=gpt_ext4</span><br><span class="line">Qcow2=yes</span><br><span class="line">Output=debian-12-minimal</span><br><span class="line"></span><br><span class="line">[Content]</span><br><span class="line">Bootable=yes</span><br><span class="line">Packages=linux-image-generic</span><br><span class="line">systemd</span><br><span class="line">systemd-boot</span><br><span class="line">systemd-sysv</span><br><span class="line">udev</span><br><span class="line">dbus</span><br><span class="line">WithDocs=yes</span><br><span class="line">CleanPackageMetadata=yes</span><br><span class="line">WithUnifiedKernelImages=no</span><br><span class="line">KernelCommandLine=console=ttyS0</span><br><span class="line">Password=toor</span><br><span class="line"></span><br><span class="line">[Partitions]</span><br><span class="line">RootSize=10G</span><br><span class="line">ESPSize=200M</span><br><span class="line">BiosSize=1M</span><br><span class="line"></span><br><span class="line">[Validation]</span><br><span class="line">SecureBoot=no</span><br></pre></td></tr></table></figure>
<p>然后执行：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkosi build</span><br></pre></td></tr></table></figure>

<h3 id="构建initramfs"><a href="#构建initramfs" class="headerlink" title="构建initramfs"></a>构建initramfs</h3><p><code>mkosi.conf</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[Output]</span><br><span class="line">Format=cpio</span><br><span class="line"></span><br><span class="line">[Content]</span><br><span class="line">Packages=systemd</span><br><span class="line">         udev</span><br><span class="line">         kmod</span><br></pre></td></tr></table></figure>

<h3 id="构建一个USI（UEFI-PE程序形式的完整系统镜像）"><a href="#构建一个USI（UEFI-PE程序形式的完整系统镜像）" class="headerlink" title="构建一个USI（UEFI PE程序形式的完整系统镜像）"></a>构建一个USI（UEFI PE程序形式的完整系统镜像）</h3><p>具体的精简方式见<a target="_blank" rel="noopener" href="https://overhead.neocities.org/blog/build-usi-mkosi/">Build USI</a>。</p>
<p><code>mkosi.conf</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[Distribution]</span><br><span class="line"># 发行版</span><br><span class="line">Distribution=arch</span><br><span class="line"></span><br><span class="line">[Content]</span><br><span class="line">MakeInitrd=no</span><br><span class="line"># USI不需要安装任何Bootloader</span><br><span class="line">Bootloader=none</span><br><span class="line">KernelCommandLine=rw</span><br><span class="line"># 我们不希望交互式初始化，跳过Firstboot</span><br><span class="line">Locale=</span><br><span class="line">Keymap=</span><br><span class="line">Timezone=</span><br><span class="line">RootPassword=</span><br><span class="line">Packages=</span><br><span class="line">	base</span><br><span class="line">	linux</span><br><span class="line">	linux-firmware</span><br><span class="line">	systemd</span><br><span class="line">	less</span><br><span class="line"></span><br><span class="line">[Output]</span><br><span class="line">Format=uki</span><br><span class="line">CompressOutput=zst</span><br><span class="line">ImageId=example-usi</span><br></pre></td></tr></table></figure>

<h3 id="构建一个系统扩展镜像"><a href="#构建一个系统扩展镜像" class="headerlink" title="构建一个系统扩展镜像"></a>构建一个系统扩展镜像</h3><p><code>mkosi.conf</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[Output]</span><br><span class="line"># 如果不希望保留基础镜像的话，使用</span><br><span class="line"># Format=none</span><br><span class="line">Format=disk</span><br><span class="line"></span><br><span class="line">[Content]</span><br><span class="line"># 会拷贝到构建时的</span><br><span class="line">BaseTrees=%O/base</span><br></pre></td></tr></table></figure>

<p><code>mkosi.images/base/mkosi.conf</code>（扩展镜像相对的基础镜像）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[Output]</span><br><span class="line">Format=directory</span><br><span class="line"># 该镜像完全是个中间镜像</span><br><span class="line"># 版本号在这里无意义</span><br><span class="line">ImageVersion=</span><br><span class="line"></span><br><span class="line">[Content]</span><br><span class="line">Bootable=no</span><br><span class="line">CleanPackageMetadata=no</span><br><span class="line">Packages=systemd</span><br><span class="line">         udev</span><br></pre></td></tr></table></figure>
<ul>
<li>在启用了<code>Incremental=yes</code>的情况下，子镜像不能是<code>Bootable=yes</code>，否则会导致Cache冲突。</li>
</ul>
<p><code>mkosi.images/btrfs/mkosi.conf</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[Config]</span><br><span class="line">Dependencies=base</span><br><span class="line"></span><br><span class="line">[Output]</span><br><span class="line">Format=sysext</span><br><span class="line">Overlay=yes</span><br><span class="line"></span><br><span class="line">[Content]</span><br><span class="line">Bootable=no</span><br><span class="line">BaseTrees=%O/base</span><br><span class="line">Packages=btrfs-progs</span><br></pre></td></tr></table></figure>

<h3 id="构建一个不可变操作系统"><a href="#构建一个不可变操作系统" class="headerlink" title="构建一个不可变操作系统"></a>构建一个不可变操作系统</h3><p>首先创建一个如下分区的操作系统：</p>
<p><code>00-esp.conf</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[Partition]</span><br><span class="line">Type=esp</span><br><span class="line">Format=vfat</span><br><span class="line">CopyFiles=/efi:/</span><br><span class="line">CopyFiles=/boot:/</span><br><span class="line">SizeMinBytes=1G</span><br><span class="line">SizeMaxBytes=1G</span><br></pre></td></tr></table></figure>
<p><code>10-root-verity-sig.conf</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[Partition]</span><br><span class="line">Type=root-verity-sig</span><br><span class="line">Label=%M_%A_verity_sig</span><br><span class="line">Verity=signature</span><br><span class="line">VerityMatchKey=root</span><br><span class="line">SplitName=%t.%U</span><br></pre></td></tr></table></figure>
<p><code>11-root-verity.conf</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[Partition]</span><br><span class="line">Type=root-verity</span><br><span class="line">Label=%M_%A_verity</span><br><span class="line">Verity=hash</span><br><span class="line">VerityMatchKey=root</span><br><span class="line">SizeMinBytes=300M</span><br><span class="line">SizeMaxBytes=300M</span><br><span class="line">SplitName=%t.%U</span><br></pre></td></tr></table></figure>
<p><code>12-root.conf</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[Partition]</span><br><span class="line">Type=root</span><br><span class="line">Format=erofs</span><br><span class="line">Label=%M_%A_root</span><br><span class="line">Verity=data</span><br><span class="line">VerityMatchKey=root</span><br><span class="line">CopyFiles=/</span><br><span class="line">ExcludeFilesTarget=/var/</span><br><span class="line">Minimize=yes</span><br><span class="line">SplitName=%t.%U</span><br></pre></td></tr></table></figure>

<p>除此之外我们还需要构建一个initramfs，initramfs中的<code>systemd-repart.service</code>的启动时间需要进行些许修改：</p>
<p><code>mkosi.images/initrd/mkosi.conf</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[Include]</span><br><span class="line">Include=mkosi-initrd</span><br></pre></td></tr></table></figure>
<p><code>mkosi.images/initrd/mkosi.extra/usr/lib/systemd/system/systemd-repart.service.d/sysroot.conf</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">After=sysroot.mount</span><br><span class="line">ConditionDirectoryNotEmpty=|/sysroot/usr/lib/repart.d</span><br></pre></td></tr></table></figure>

<p>为了进行AB更新，我们还需要在镜像中包含一些预设的分区配置：</p>
<p><code>mkosi.extra/usr/lib/repart.d/00-esp.conf</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[Partition]</span><br><span class="line">Type=esp</span><br></pre></td></tr></table></figure>
<p><code>mkosi.extra/usr/lib/repart.d/10-root-verity-sig.conf</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[Partition]</span><br><span class="line">Type=root-verity-sig</span><br><span class="line">Label=%M_%A_verity_sig</span><br></pre></td></tr></table></figure>
<p><code>mkosi.extra/usr/lib/repart.d/11-root-verity.conf</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[Partition]</span><br><span class="line">Type=root-verity</span><br><span class="line">Label=%M_%A_verity</span><br></pre></td></tr></table></figure>
<p><code>mkosi.extra/usr/lib/repart.d/12-root.conf</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[Partition]</span><br><span class="line">Type=root</span><br><span class="line">Label=%M_%A</span><br><span class="line">SizeMinBytes=2G</span><br><span class="line">SizeMaxBytes=2G</span><br></pre></td></tr></table></figure>
<p><code>mkosi.extra/usr/lib/repart.d/20-root-verity-sig.conf</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[Partition]</span><br><span class="line">Type=root-verity-sig</span><br><span class="line">Label=_empty</span><br></pre></td></tr></table></figure>
<p><code>mkosi.extra/usr/lib/repart.d/21-root-verity.conf</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[Partition]</span><br><span class="line">Type=root-verity</span><br><span class="line">Label=_empty</span><br><span class="line">SizeMinBytes=300M</span><br><span class="line">SizeMaxBytes=300M</span><br></pre></td></tr></table></figure>
<p><code>mkosi.extra/usr/lib/repart.d/22-root.conf</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[Partition]</span><br><span class="line">Type=root</span><br><span class="line">Label=_empty</span><br><span class="line">SizeMinBytes=2G</span><br><span class="line">SizeMaxBytes=2G</span><br></pre></td></tr></table></figure>
<p><code>mkosi.extra/usr/lib/repart.d/30-swap.conf</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[Partition]</span><br><span class="line">Type=swap</span><br><span class="line">Format=swap</span><br><span class="line">Encrypt=tpm2</span><br><span class="line">SizeMinBytes=4G</span><br><span class="line">SizeMaxBytes=4G</span><br></pre></td></tr></table></figure>
<p><code>mkosi.extra/usr/lib/repart.d/40-var.conf</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[Partition]</span><br><span class="line">Type=var</span><br><span class="line">Format=ext4</span><br><span class="line">Encrypt=tpm2</span><br><span class="line">SizeMinBytes=2G</span><br></pre></td></tr></table></figure>

<p>因为<code>/etc</code>不可变，所以我们还需要在构建时提供Machine ID：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemd-id128 new &gt; mkosi.machine-id</span><br></pre></td></tr></table></figure>

<p>最后为了未来镜像中的系统更新，我们还需要提供<code>systemd-sysupdate</code>的配置（你需要自行补充<code>[Source]</code>段）：</p>
<p><code>mkosi.extra/usr/lib/sysupdate.d/10-root-verity-sig.transfer</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[Transfer]</span><br><span class="line">ProtectVersion=%A</span><br><span class="line"></span><br><span class="line">[Target]</span><br><span class="line">Type=partition</span><br><span class="line">Path=auto</span><br><span class="line">MatchPattern=%M_@v_verity_sig</span><br><span class="line">MatchPartitionType=root-verity-sig</span><br><span class="line">PartitionFlags=0</span><br><span class="line">ReadOnly=1</span><br></pre></td></tr></table></figure>
<p><code>mkosi.extra/usr/lib/sysupdate.d/11-root-verity.transfer</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[Transfer]</span><br><span class="line">ProtectVersion=%A</span><br><span class="line"></span><br><span class="line">[Target]</span><br><span class="line">Type=partition</span><br><span class="line">Path=auto</span><br><span class="line">MatchPattern=%M_@v_verity</span><br><span class="line">MatchPartitionType=root-verity</span><br><span class="line">PartitionFlags=0</span><br><span class="line">ReadOnly=1</span><br></pre></td></tr></table></figure>
<p><code>mkosi.extra/usr/lib/sysupdate.d/12-root.transfer</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[Transfer]</span><br><span class="line">ProtectVersion=%A</span><br><span class="line"></span><br><span class="line">[Target]</span><br><span class="line">Type=partition</span><br><span class="line">Path=auto</span><br><span class="line">MatchPattern=%M_@v</span><br><span class="line">MatchPartitionType=root</span><br><span class="line">PartitionFlags=0</span><br><span class="line">ReadOnly=1</span><br></pre></td></tr></table></figure>
<p><code>mkosi.extra/usr/lib/sysupdate.d/20-uki.transfer</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[Transfer]</span><br><span class="line">ProtectVersion=%A</span><br><span class="line"></span><br><span class="line">[Target]</span><br><span class="line">Type=regular-file</span><br><span class="line">Path=/EFI/Linux</span><br><span class="line">PathRelativeTo=boot</span><br><span class="line">MatchPattern=%M_@v+@l-@d.efi \</span><br><span class="line">             %M_@v+@l.efi \</span><br><span class="line">             %M_@v.efi</span><br><span class="line">Mode=0444</span><br><span class="line">TriesLeft=3</span><br><span class="line">TriesDone=0</span><br><span class="line">InstancesMax=2</span><br></pre></td></tr></table></figure>

<h3 id="构建一个不安全的-usr不可变操作系统"><a href="#构建一个不安全的-usr不可变操作系统" class="headerlink" title="构建一个不安全的/usr不可变操作系统"></a>构建一个不安全的<code>/usr</code>不可变操作系统</h3><p>由于上文提到的原因（UKI必须使用Verity Hash对<code>/usr/</code>分区进行定位），我们无法让MKOSI在构建镜像时，自动向UKI中填充<code>/usr/</code>分区所在的位置，因此，我们必须手动在<code>mkosi.conf</code>中设置：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[Content]</span><br><span class="line"># 要么根文件系统在initramfs中是可写的，要么存在/usr目录，否则会导致挂载失败</span><br><span class="line"># 也可以使用mount.usr=PARTUUID</span><br><span class="line">KernelCommandLine=rw mount.usr=PARTLABEL=%i_%v</span><br></pre></td></tr></table></figure>

<p><code>systemd-repart</code>配置如下：</p>
<p><code>00-esp.conf</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[Partition]</span><br><span class="line">Type=esp</span><br><span class="line">Format=vfat</span><br><span class="line">CopyFiles=/efi:/</span><br><span class="line">CopyFiles=/boot:/</span><br><span class="line">SizeMinBytes=1G</span><br><span class="line">SizeMaxBytes=1G</span><br></pre></td></tr></table></figure>

<p><code>10-usr.conf</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[Partition]</span><br><span class="line">Type=usr</span><br><span class="line"># 注意这里，和内核命令行参数一致</span><br><span class="line">Label=%M_%A</span><br><span class="line">Format=erofs</span><br><span class="line">CopyFiles=/usr:/</span><br><span class="line">Minimize=yes</span><br><span class="line">SplitName=%t.%U</span><br></pre></td></tr></table></figure>

<p>此外，还需要在镜像内提供一些分区配置：</p>
<p><code>mkosi.extra/usr/lib/repart.d/00-esp.conf</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[Partition]</span><br><span class="line">Type=esp</span><br></pre></td></tr></table></figure>

<p><code>mkosi.extra/usr/lib/repart.d/10-usr-verA.conf</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[Partition]</span><br><span class="line">Type=usr</span><br><span class="line">Label=%M_%A</span><br><span class="line">SizeMinBytes=5G</span><br><span class="line">SizeMaxBytes=20G</span><br><span class="line">Weight=2000</span><br></pre></td></tr></table></figure>

<p><code>mkosi.extra/usr/lib/repart.d/20-usr-verB.conf</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[Partition]</span><br><span class="line">Type=usr</span><br><span class="line">Label=_empty</span><br><span class="line">SizeMinBytes=5G</span><br><span class="line">SizeMaxBytes=20G</span><br><span class="line">Weight=2000</span><br></pre></td></tr></table></figure>

<p><code>mkosi.extra/usr/lib/repart.d/30-swap.conf</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[Partition]</span><br><span class="line">Type=swap</span><br><span class="line">Format=swap</span><br><span class="line">SizeMinBytes=4G</span><br><span class="line">SizeMaxBytes=4G</span><br></pre></td></tr></table></figure>

<p><code>mkosi.extra/usr/lib/repart.d/40-root.conf</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[Partition]</span><br><span class="line">Type=root</span><br><span class="line">Format=btrfs</span><br><span class="line">SizeMinBytes=1G</span><br><span class="line">Weight=20000</span><br><span class="line">Subvolumes=/var</span><br><span class="line"># 这是为了使systemd-journald使用持久模式</span><br><span class="line">MakeDirectories=/var/log/journal</span><br></pre></td></tr></table></figure>

<p><code>mkosi.extra/usr/lib/repart.d/50-home.conf</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[Partition]</span><br><span class="line">Type=home</span><br><span class="line">Format=btrfs</span><br><span class="line">SizeMinBytes=1G</span><br><span class="line">Weight=40000</span><br></pre></td></tr></table></figure>

<p>我们还需要确保<code>/etc/</code>目录在启动时动态生成，因此需要：</p>
<p><code>mkosi.extra/usr/lib/tmpfiles.d/etc.conf</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"># 仅作参考</span><br><span class="line"># This overrides the same file from systemd since we want to symlink everything</span><br><span class="line"># into /etc instead of copying so updates to /usr propagate properly.</span><br><span class="line">L /etc/os-release - - - - ../usr/lib/os-release</span><br><span class="line"># mtab needs to be refreshed on every boot.</span><br><span class="line">L+ /etc/mtab - - - - ../proc/self/mounts</span><br><span class="line"># Contains the default systemd locale</span><br><span class="line">L /etc/locale.conf</span><br><span class="line">L /etc/nsswitch.conf</span><br><span class="line">L /etc/issue</span><br><span class="line">L /etc/profile</span><br><span class="line"># Required by pam_env plugin</span><br><span class="line">L /etc/security</span><br><span class="line">L /etc/bash.bashrc</span><br><span class="line">L /etc/bash.bash_logout</span><br><span class="line"># Canonical location to look for certificates</span><br><span class="line">L /etc/ca-certificates</span><br><span class="line">L /etc/debuginfod</span><br><span class="line">L /etc/ssh</span><br><span class="line"># Canonical location to look for certificates</span><br><span class="line">L /etc/ssl</span><br><span class="line"># Required by pam environment plugin</span><br><span class="line">L /etc/environment</span><br><span class="line"># Contains the archlinux keyring required to build images</span><br><span class="line">L /etc/pacman.d</span><br><span class="line"># Required to generate desktop environment application menus</span><br><span class="line">L /etc/xdg</span><br><span class="line"># Contains default font configuration</span><br><span class="line">L /etc/fonts</span><br><span class="line"># Configuration for man</span><br><span class="line">L /etc/man_db.conf</span><br><span class="line"># Configuration for ldconfig</span><br><span class="line">L /etc/ld.so.conf</span><br><span class="line">L /etc/ld.so.conf.d</span><br><span class="line"># We NEED authselect to correctly login</span><br><span class="line">L /etc/authselect</span><br><span class="line">L /etc/sysconfig</span><br></pre></td></tr></table></figure>

<p>为了确保<code>ldconfig.service</code>在<code>/etc/</code>目录生成后再启动，我们还需要：</p>
<p><code>mkosi.extra/usr/lib/systemd/system/ldconfig.service.d/tmpfiles.conf</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">After=systemd-tmpfiles-setup.service</span><br></pre></td></tr></table></figure>

<p>最后，我们需要MKOSI的更新配置：</p>
<p><code>mkosi.sysupdate/10-usr.transfer</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[Transfer]</span><br><span class="line">ProtectVersion=%A</span><br><span class="line"></span><br><span class="line">[Source]</span><br><span class="line">Type=regular-file</span><br><span class="line">Path=/</span><br><span class="line">PathRelativeTo=explicit</span><br><span class="line">MatchPattern=%M_@v.usr-%a.@u.raw</span><br><span class="line"></span><br><span class="line">[Target]</span><br><span class="line">Type=partition</span><br><span class="line">Path=auto</span><br><span class="line">MatchPattern=%M_@v</span><br><span class="line">MatchPartitionType=usr</span><br><span class="line">PartitionFlags=0</span><br><span class="line">ReadOnly=1</span><br></pre></td></tr></table></figure>

<p><code>mkosi.sysupdate/20-uki.transfer</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[Transfer]</span><br><span class="line">ProtectVersion=%A</span><br><span class="line"></span><br><span class="line">[Source]</span><br><span class="line">Type=regular-file</span><br><span class="line">Path=/</span><br><span class="line">PathRelativeTo=explicit</span><br><span class="line">MatchPattern=%M_@v.efi</span><br><span class="line"></span><br><span class="line">[Target]</span><br><span class="line">Type=regular-file</span><br><span class="line">Path=/EFI/Linux</span><br><span class="line">PathRelativeTo=boot</span><br><span class="line">MatchPattern=%M_@v+@l-@d.efi \</span><br><span class="line">             %M_@v+@l.efi \</span><br><span class="line">             %M_@v.efi</span><br><span class="line">Mode=0444</span><br><span class="line">TriesLeft=3</span><br><span class="line">TriesDone=0</span><br><span class="line">InstancesMax=2</span><br></pre></td></tr></table></figure>

    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2024/02/04/Incus%E6%89%8B%E5%86%8C/" rel="prev" title="Incus手册">
                  <i class="fa fa-angle-left"></i> Incus手册
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2024/03/31/CGroup-v1-v2%E5%85%A8%E8%A7%A3/" rel="next" title="CGroup v1 && v2全解">
                  CGroup v1 && v2全解 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Kwok "Molten_Armor" Guy</span>
  </div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
